(window.webpackJsonp=window.webpackJsonp||[]).push([["webgl"],{80:function(e,t,r){"use strict";r.r(t);var a=r(53),i=r(66),n=r(29),o=r(32),s=r(21),u=r(9),l=r(19),c=r(3),m=r(5),p=r(2),d=r(0),_=r(8),h=function(){function e(){this.__webglResourceRepository=i.a.getInstance(),this.__uboUid=c.a.InvalidCGAPIResourceUid,this.__vertexHandles=[],this.__isVAOSet=!1,this.vertexShaderMethodDefinitions_UBO="layout (std140) uniform matrix {\n    mat4 world[1024];\n  } u_matrix;\n\n  uniform mat4 u_viewMatrix;\n  uniform mat4 u_projectionMatrix;\n  uniform mat3 u_normalMatrix;\n\n  mat4 getMatrix(float instanceId) {\n    float index = instanceId;\n    return transpose(u_matrix.world[int(index)]);\n  }\n\n  mat4 getViewMatrix(float instanceId) {\n    return u_viewMatrix;\n  }\n\n  mat4 getProjectionMatrix(float instanceId) {\n    return u_projectionMatrix;\n  }\n\n  mat3 getNormalMatrix(float instanceId) {\n    return u_normalMatrix;\n  }\n\n  "}return e.prototype.setupShaderProgram=function(e){if(null!=e.mesh)for(var t=e.mesh.getPrimitiveNumber(),r=0;r<t;r++){var a=e.mesh.getPrimitiveAt(r).material;if(a){if(a._shaderProgramUid!==c.a.InvalidCGAPIResourceUid)return;a.createProgram(this.vertexShaderMethodDefinitions_UBO,m.a.getShaderProperty),this.__webglResourceRepository.setupUniformLocations(a._shaderProgramUid,[{semantic:m.a.ViewMatrix,compositionType:d.a.Mat4,componentType:p.a.Float,stage:_.a.VertexShader,min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isPlural:!1,isSystem:!0},{semantic:m.a.ProjectionMatrix,compositionType:d.a.Mat4,componentType:p.a.Float,stage:_.a.VertexShader,min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isPlural:!1,isSystem:!0}])}}else l.a.alertNoMeshSet(e)},e.prototype.__isLoaded=function(e){return null!=this.__vertexHandles[e]},e.prototype.$load=function(t){if(!this.__isLoaded(0))if(null!=t.mesh){this.setupShaderProgram(t);for(var r=t.mesh.getPrimitiveNumber(),a=0;a<r;a++){var i=t.mesh.getPrimitiveAt(a),n=this.__webglResourceRepository.createVertexDataResources(i);this.__vertexHandles[a]=n,e.__vertexHandleOfPrimitiveObjectUids.set(i.objectUID,n)}}else l.a.alertNoMeshSet(t)},e.prototype.$prerender=function(t,r,a){if(!this.__isVAOSet)if(null!=t.mesh){for(var i=t.mesh.getPrimitiveNumber(),n=0;n<i;n++){var o=t.mesh.getPrimitiveAt(n);this.__vertexHandles[n]=e.__vertexHandleOfPrimitiveObjectUids.get(o.objectUID),this.__webglResourceRepository.setVertexDataToPipeline(this.__vertexHandles[n],o,a)}this.__isVAOSet=!0}else l.a.alertNoMeshSet(t)},e.prototype.common_$prerender=function(){var e=n.a.getInstance().getBuffer(u.a.GPUInstanceData);new Float32Array(e.getArrayBuffer());this.__uboUid===c.a.InvalidCGAPIResourceUid?(this.__uboUid=this.__webglResourceRepository.createUniformBuffer(s.a.getAccessor("worldMatrix",s.a).dataViewOfBufferView),this.__webglResourceRepository.bindUniformBufferBase(0,this.__uboUid)):this.__webglResourceRepository.updateUniformBuffer(this.__uboUid,s.a.getAccessor("worldMatrix",s.a).dataViewOfBufferView)},e.prototype.attachGPUData=function(e){this.__webglResourceRepository.bindUniformBlock(e.material._shaderProgramUid,"matrix",0)},e.prototype.attatchShaderProgram=function(e){var t=e._shaderProgramUid,r=this.__webglResourceRepository.currentWebGLContextWrapper.getRawContext(),a=this.__webglResourceRepository.getWebGLResource(t);r.useProgram(a)},e.prototype.attachVertexData=function(e,t,r,a){var i=this.__vertexHandles[e],n=this.__webglResourceRepository.getWebGLResource(i.vaoHandle),o=r.getRawContext();if(null!=n)r.bindVertexArray(n);else{this.__webglResourceRepository.setVertexDataToPipeline(i,t,a);var s=this.__webglResourceRepository.getWebGLResource(i.iboHandle);o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,s)}},e.getInstance=function(){return this.__instance||(this.__instance=new e),this.__instance},e.prototype.common_$render=function(e,t,r,a){var i=this.__webglResourceRepository.currentWebGLContextWrapper,n=e.material;this.attatchShaderProgram(n);i.getRawContext();var o=this.__webglResourceRepository.getWebGLResource(n._shaderProgramUid);return this.__webglResourceRepository.setUniformValue(o,m.a.ViewMatrix.str,!0,t),this.__webglResourceRepository.setUniformValue(o,m.a.ProjectionMatrix.str,!0,r),!0},e.__vertexHandleOfPrimitiveObjectUids=new Map,e}(),g=r(45),f=r(40),x=r(17),b=r(36),y=r(38),R=r(4),v=r(23),w=r(70),U=function(){function e(){this.__webglResourceRepository=i.a.getInstance(),this.__instanceDataTextureUid=c.a.InvalidCGAPIResourceUid,this.__vertexDataTextureUid=c.a.InvalidCGAPIResourceUid,this.__primitiveHeaderUboUid=c.a.InvalidCGAPIResourceUid,this.__indexCountToSubtractUboUid=c.a.InvalidCGAPIResourceUid,this.__entitiesUidUboUid=c.a.InvalidCGAPIResourceUid,this.__primitiveUidUboUid=c.a.InvalidCGAPIResourceUid,this.__isVertexReady=!1}return Object.defineProperty(e.prototype,"__transformFeedbackShaderText",{get:function(){w.a.getInstance().glsl_vertex_in,w.a.getInstance().glsl_texture;return"\n    uniform mat4 u_worldMatrix;\n    uniform mat4 u_viewMatrix;\n    uniform mat4 u_projectionMatrix;\n    uniform mat3 u_normalMatrix;\n\n    mat4 getMatrix(float instanceId) {\n      return u_worldMatrix;\n    }\n\n    mat4 getViewMatrix(float instanceId) {\n      return u_viewMatrix;\n    }\n\n    mat4 getProjectionMatrix(float instanceId) {\n      return u_projectionMatrix;\n    }\n\n    mat3 getNormalMatrix(float instanceId) {\n      return u_normalMatrix;\n    }\n\n    layout (std140) uniform indexCountsToSubtract {\n      ivec4 counts[256];\n    } u_indexCountsToSubtract;\n    layout (std140) uniform entityUids {\n      ivec4 ids[256];\n    } u_entityData;\n    layout (std140) uniform primitiveUids {\n      ivec4 ids[256];\n    } u_primitiveData;\n    layout (std140) uniform primitiveHeader {\n      ivec4 data[256];\n    } u_primitiveHeader;\n\n    out vec4 position;\n    //out vec3 colors;\n\n    uniform sampler2D u_instanceDataTexture;\n    uniform sampler2D u_vertexDataTexture;\n\n    // void main(){\n    //   int indexOfVertices = gl_VertexID + 3*gl_InstanceID;\n\n    //   int entityUidMinusOne = 0;\n    //   int primitiveUid = 0;\n    //   for (int i=0; i<=indexOfVertices; i++) {\n    //     for (int j=0; j<1024; j++) {\n    //       int value = u_indexCountsToSubtract.counts[j/4][j%4];\n    //       int result = int(step(float(value), float(i)));\n    //       if (result > 0) {\n    //         entityUidMinusOne = result * int(u_entityData.ids[j/4][j%4]) - 1;\n    //         primitiveUid = result * u_primitiveData.ids[j/4][j%4];\n    //       } else {\n    //         break;\n    //       }\n    //     }\n    //   }\n\n    //   ivec4 indicesMeta = u_primitiveHeader.data[9*primitiveUid + 0];\n    //   int primIndicesByteOffset = indicesMeta.x;\n    //   int primIndicesComponentSizeInByte = indicesMeta.y;\n    //   int primIndicesLength = indicesMeta.z;\n\n    //   int idx = gl_VertexID - primIndicesByteOffset / 4 /*byte*/;\n\n    //   // get Indices\n    //   int texelLength = "+n.a.bufferWidthLength+";\n    //   vec4 indexVec4 = texelFetch(u_vertexDataTexture, ivec2(idx%texelLength, idx/texelLength), 0);\n    //   int index = int(indexVec4[idx%4]);\n\n    //   // get Positions\n    //   ivec4 indicesData = u_primitiveHeader.data[9*primitiveUid + 1];\n    //   int primPositionsByteOffset = indicesData.x;\n    //   idx = primPositionsByteOffset/4 + index;\n    //   vec4 posVec4 = texelFetch(u_vertexDataTexture, ivec2(idx%texelLength, idx/texelLength), 0);\n\n    //   position = posVec4;\n    //}\n"},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"__transformFeedbackFragmentShaderText",{get:function(){return"#version 300 es\nprecision highp float;\n\nout vec4 outColor;\n\nvoid main(){\n    outColor = vec4(1.0);\n}\n    "},enumerable:!0,configurable:!0}),e.prototype.setupShaderProgram=function(e){if(null!=e.mesh)for(var t=e.mesh.getPrimitiveNumber(),r=0;r<t;r++){var a=e.mesh.getPrimitiveAt(r).material;if(a){if(a._shaderProgramUid!==c.a.InvalidCGAPIResourceUid)return;a.createProgram(this.__transformFeedbackShaderText,m.a.getShaderProperty),this.__webglResourceRepository.setupUniformLocations(a._shaderProgramUid,[{semantic:m.a.ViewMatrix,compositionType:d.a.Mat4,componentType:p.a.Float,stage:_.a.VertexShader,min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isPlural:!1,isSystem:!0},{semantic:m.a.ProjectionMatrix,compositionType:d.a.Mat4,componentType:p.a.Float,stage:_.a.VertexShader,min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isPlural:!1,isSystem:!0}])}}else l.a.alertNoMeshSet(e)},e.prototype.$load=function(e){if(!this.__isVertexReady){this.setupShaderProgram(e);var t=n.a.getInstance().getBuffer(u.a.CPUGeneric),r=t.takeBufferView({byteLengthToNeed:12,byteStride:4,isAoS:!1}).takeAccessor({compositionType:d.a.Scalar,componentType:p.a.UnsingedInt,count:3}),a=t.takeBufferView({byteLengthToNeed:48,byteStride:16,isAoS:!1}).takeAccessor({compositionType:d.a.Vec4,componentType:p.a.Float,count:3}),i=r.getTypedArray();i[0]=0,i[1]=1,i[2]=2;var o=y.a.createPrimitive({indices:i,attributeCompositionTypes:[a.compositionType],attributeSemantics:[R.a.Position],attributes:[a.getTypedArray()],primitiveMode:v.a.Triangles,material:void 0});this.__vertexHandle=this.__webglResourceRepository.createVertexDataResources(o),this.__isVertexReady=!0}},e.prototype.$prerender=function(e,t,r){},e.prototype.__setupUBOPrimitiveHeaderData=function(){var e=n.a.getInstance().getBuffer(u.a.UBOGeneric),t=new Int32Array(e.getArrayBuffer());this.__primitiveHeaderUboUid===c.a.InvalidCGAPIResourceUid&&(this.__primitiveHeaderUboUid=this.__webglResourceRepository.createUniformBuffer(t),this.__webglResourceRepository.bindUniformBufferBase(3,this.__primitiveHeaderUboUid))},e.prototype.__setupGPUInstanceMetaData=function(){if(this.__primitiveUidUboUid===c.a.InvalidCGAPIResourceUid){var e=b.a.getInstance()._getEntities(),t=new Int32Array(e.length),r=new Int32Array(e.length),a=new Int32Array(e.length),i=0;e.forEach(function(e,n){var o=e.getComponent(l.a);if(o&&o.mesh){r[n]=o.mesh.getPrimitiveAt(0).primitiveUid,t[n]=e.entityUID;var s=o.mesh.getPrimitiveAt(0).indicesAccessor.elementCount;a[n]=i+s,i+=s}}),this.__indexCountToSubtractUboUid=this.__webglResourceRepository.createUniformBuffer(a),this.__webglResourceRepository.bindUniformBufferBase(0,this.__indexCountToSubtractUboUid),this.__entitiesUidUboUid=this.__webglResourceRepository.createUniformBuffer(t),this.__webglResourceRepository.bindUniformBufferBase(1,this.__entitiesUidUboUid),this.__primitiveUidUboUid=this.__webglResourceRepository.createUniformBuffer(r),this.__webglResourceRepository.bindUniformBufferBase(2,this.__primitiveUidUboUid)}},e.prototype.__setupGPUInstanceData=function(){var e=!1;(this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2||this.__webglResourceRepository.currentWebGLContextWrapper.isSupportWebGL1Extension(g.a.TextureHalfFloat))&&(e=!0);var t,r=n.a.getInstance().getBuffer(u.a.GPUInstanceData),a=new Float32Array(r.getArrayBuffer());if(e){t=new Uint16Array(a.length);for(var i=r.takenSizeInByte/4,s=0;s<i;s++)t[s]=o.a.toHalfFloat(a[s])}this.__instanceDataTextureUid===c.a.InvalidCGAPIResourceUid?e?this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2?this.__instanceDataTextureUid=this.__webglResourceRepository.createTexture(a,{level:0,internalFormat:x.a.RGBA16F,width:n.a.bufferWidthLength,height:n.a.bufferHeightLength,border:0,format:f.a.RGBA,type:p.a.Float,magFilter:x.a.Nearest,minFilter:x.a.Nearest,wrapS:x.a.Repeat,wrapT:x.a.Repeat,generateMipmap:!1,anisotropy:!1}):this.__instanceDataTextureUid=this.__webglResourceRepository.createTexture(t,{level:0,internalFormat:f.a.RGBA,width:n.a.bufferWidthLength,height:n.a.bufferHeightLength,border:0,format:f.a.RGBA,type:p.a.HalfFloat,magFilter:x.a.Nearest,minFilter:x.a.Nearest,wrapS:x.a.Repeat,wrapT:x.a.Repeat,generateMipmap:!1,anisotropy:!1}):this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2?this.__instanceDataTextureUid=this.__webglResourceRepository.createTexture(a,{level:0,internalFormat:x.a.RGBA32F,width:n.a.bufferWidthLength,height:n.a.bufferHeightLength,border:0,format:f.a.RGBA,type:p.a.Float,magFilter:x.a.Nearest,minFilter:x.a.Nearest,wrapS:x.a.Repeat,wrapT:x.a.Repeat,generateMipmap:!1,anisotropy:!1}):this.__instanceDataTextureUid=this.__webglResourceRepository.createTexture(a,{level:0,internalFormat:f.a.RGBA,width:n.a.bufferWidthLength,height:n.a.bufferHeightLength,border:0,format:f.a.RGBA,type:p.a.Float,magFilter:x.a.Nearest,minFilter:x.a.Nearest,wrapS:x.a.Repeat,wrapT:x.a.Repeat,generateMipmap:!1,anisotropy:!1}):e?this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2?this.__webglResourceRepository.updateTexture(this.__instanceDataTextureUid,a,{level:0,width:n.a.bufferWidthLength,height:n.a.bufferHeightLength,format:f.a.RGBA,type:p.a.Float}):this.__webglResourceRepository.updateTexture(this.__instanceDataTextureUid,t,{level:0,width:n.a.bufferWidthLength,height:n.a.bufferHeightLength,format:f.a.RGBA,type:p.a.HalfFloat}):(this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2,this.__webglResourceRepository.updateTexture(this.__instanceDataTextureUid,a,{level:0,width:n.a.bufferWidthLength,height:n.a.bufferHeightLength,format:f.a.RGBA,type:p.a.Float}))},e.prototype.__setupGPUVertexData=function(){if(this.__vertexDataTextureUid===c.a.InvalidCGAPIResourceUid){var e=n.a.getInstance().getBuffer(u.a.GPUVertexData),t=new Float32Array(e.getArrayBuffer());this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2?this.__vertexDataTextureUid=this.__webglResourceRepository.createTexture(t,{level:0,internalFormat:x.a.RGBA32F,width:n.a.bufferWidthLength,height:n.a.bufferHeightLength,border:0,format:f.a.RGBA,type:p.a.Float,magFilter:x.a.Nearest,minFilter:x.a.Nearest,wrapS:x.a.Repeat,wrapT:x.a.Repeat,generateMipmap:!1,anisotropy:!1}):this.__vertexDataTextureUid=this.__webglResourceRepository.createTexture(t,{level:0,internalFormat:f.a.RGBA,width:n.a.bufferWidthLength,height:n.a.bufferHeightLength,border:0,format:f.a.RGBA,type:p.a.Float,magFilter:x.a.Nearest,minFilter:x.a.Nearest,wrapS:x.a.Repeat,wrapT:x.a.Repeat,generateMipmap:!1,anisotropy:!1})}},e.prototype.common_$prerender=function(){this.__setupUBOPrimitiveHeaderData(),this.__setupGPUInstanceMetaData(),this.__setupGPUInstanceData(),this.__setupGPUVertexData()},e.prototype.attachGPUData=function(e){var t=e.material,r=(o=this.__webglResourceRepository.currentWebGLContextWrapper).getRawContext(),a=this.__webglResourceRepository.getWebGLResource(this.__instanceDataTextureUid);o.bindTexture2D(0,a);var i=this.__webglResourceRepository.getWebGLResource(t._shaderProgramUid),n=r.getUniformLocation(i,"u_instanceDataTexture");r.uniform1i(n,0);var o;r=(o=this.__webglResourceRepository.currentWebGLContextWrapper).getRawContext(),a=this.__webglResourceRepository.getWebGLResource(this.__vertexDataTextureUid);o.bindTexture2D(1,a);i=this.__webglResourceRepository.getWebGLResource(t._shaderProgramUid);var s=r.getUniformLocation(i,"u_vertexDataTexture");r.uniform1i(s,1),this.__webglResourceRepository.bindUniformBlock(t._shaderProgramUid,"indexCountsToSubtract",0),this.__webglResourceRepository.bindUniformBlock(t._shaderProgramUid,"entityUids",1),this.__webglResourceRepository.bindUniformBlock(t._shaderProgramUid,"primitiveUids",2),this.__webglResourceRepository.bindUniformBlock(t._shaderProgramUid,"primitiveHeader",3)},e.prototype.attatchShaderProgram=function(e){var t=e._shaderProgramUid,r=this.__webglResourceRepository.currentWebGLContextWrapper.getRawContext(),a=this.__webglResourceRepository.getWebGLResource(t);r.useProgram(a)},e.prototype.attachVertexData=function(e,t,r,a){},e.getInstance=function(){return this.__instance||(this.__instance=new e),this.__instance},e.prototype.common_$render=function(e,t,r,a){var i=e.material,n=this.__webglResourceRepository.currentWebGLContextWrapper;this.attatchShaderProgram(e.material);n.getRawContext();var o=this.__webglResourceRepository.getWebGLResource(i._shaderProgramUid);return this.__webglResourceRepository.setUniformValue(o,m.a.ViewMatrix.str,!0,t),this.__webglResourceRepository.setUniformValue(o,m.a.ProjectionMatrix.str,!0,r),!0},e}(),T=r(28),P=function(){function e(){this.__webglResourceRepository=i.a.getInstance(),this.__dataTextureUid=c.a.InvalidCGAPIResourceUid,this.__vertexHandles=[],this.__isVAOSet=!1}return Object.defineProperty(e.prototype,"vertexShaderMethodDefinitions_dataTexture",{get:function(){var e=w.a.getInstance().glsl_texture;return"\n  uniform sampler2D u_dataTexture;\n  uniform mat4 u_viewMatrix;\n  uniform mat4 u_projectionMatrix;\n  uniform mat3 u_normalMatrix;\n\n  /*\n   * This idea from https://qiita.com/YVT/items/c695ab4b3cf7faa93885\n   * arg = vec2(1. / size.x, 1. / size.x / size.y);\n   */\n  // vec4 fetchElement(sampler2D tex, float index, vec2 arg)\n  // {\n  //   return "+e+"( tex, arg * (index + 0.5) );\n  // }\n\n  vec4 fetchElement(sampler2D tex, float index, vec2 invSize)\n  {\n    float t = (index + 0.5) * invSize.x;\n    float x = fract(t);\n    float y = (floor(t) + 0.5) * invSize.y;\n    return "+e+"( tex, vec2(x, y) );\n  }\n\n  mat4 getMatrix(float instanceId)\n  {\n    float index = "+T.a.getLocationOffsetOfMemberOfComponent(s.a,"worldMatrix")+".0 + 4.0 * instanceId;\n    float powWidthVal = "+n.a.bufferWidthLength+".0;\n    float powHeightVal = "+n.a.bufferHeightLength+".0;\n    vec2 arg = vec2(1.0/powWidthVal, 1.0/powHeightVal);\n  //  vec2 arg = vec2(1.0/powWidthVal, 1.0/powWidthVal/powHeightVal);\n\n    vec4 col0 = fetchElement(u_dataTexture, index + 0.0, arg);\n    vec4 col1 = fetchElement(u_dataTexture, index + 1.0, arg);\n    vec4 col2 = fetchElement(u_dataTexture, index + 2.0, arg);\n\n    mat4 matrix = mat4(\n      col0.x, col1.x, col2.x, 0.0,\n      col0.y, col1.y, col2.y, 0.0,\n      col0.z, col1.z, col2.z, 0.0,\n      col0.w, col1.w, col2.w, 1.0\n      );\n\n    return matrix;\n  }\n\n  mat4 getViewMatrix(float instanceId) {\n    return u_viewMatrix;\n  }\n\n  mat4 getProjectionMatrix(float instanceId) {\n    return u_projectionMatrix;\n  }\n\n  mat3 getNormalMatrix(float instanceId) {\n    return u_normalMatrix;\n  }\n\n  "},enumerable:!0,configurable:!0}),e.prototype.setupShaderProgram=function(e){if(null!=e.mesh)for(var t=e.mesh.getPrimitiveNumber(),r=0;r<t;r++){var a=e.mesh.getPrimitiveAt(r).material;if(a){if(a._shaderProgramUid!==c.a.InvalidCGAPIResourceUid)return;a.createProgram(this.vertexShaderMethodDefinitions_dataTexture,m.a.getShaderProperty),this.__webglResourceRepository.setupUniformLocations(a._shaderProgramUid,[{semantic:m.a.ViewMatrix,compositionType:d.a.Mat4,componentType:p.a.Float,stage:_.a.VertexShader,min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isPlural:!1,isSystem:!0},{semantic:m.a.ProjectionMatrix,compositionType:d.a.Mat4,componentType:p.a.Float,stage:_.a.VertexShader,min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isPlural:!1,isSystem:!0}])}}else l.a.alertNoMeshSet(e)},e.prototype.__isLoaded=function(e){return null!=this.__vertexHandles[e]},e.prototype.$load=function(t){if(!this.__isLoaded(0))if(this.__meshComponent=t,null!=t.mesh){this.setupShaderProgram(t);for(var r=t.mesh.getPrimitiveNumber(),a=0;a<r;a++){var i=t.mesh.getPrimitiveAt(a),n=this.__webglResourceRepository.createVertexDataResources(i);this.__vertexHandles[a]=n,e.__vertexHandleOfPrimitiveObjectUids.set(i.objectUID,n)}}else l.a.alertNoMeshSet(t)},e.prototype.$prerender=function(t,r,a){if(!this.__isVAOSet)if(null!=t.mesh){for(var i=t.mesh.getPrimitiveNumber(),n=0;n<i;n++){var o=t.mesh.getPrimitiveAt(n);this.__vertexHandles[n]=e.__vertexHandleOfPrimitiveObjectUids.get(o.objectUID),this.__webglResourceRepository.setVertexDataToPipeline(this.__vertexHandles[n],o,a)}this.__isVAOSet=!0}else l.a.alertNoMeshSet(t)},e.prototype.common_$prerender=function(){var e=n.a.getInstance().getBuffer(u.a.GPUInstanceData),t=new Float32Array(e.getArrayBuffer());if(this.__dataTextureUid!==c.a.InvalidCGAPIResourceUid)return this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2,void this.__webglResourceRepository.updateTexture(this.__dataTextureUid,t,{level:0,width:n.a.bufferWidthLength,height:e.takenSizeInByte/n.a.bufferWidthLength/4,format:f.a.RGBA,type:p.a.Float});this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2?this.__dataTextureUid=this.__webglResourceRepository.createTexture(t,{level:0,internalFormat:x.a.RGBA32F,width:n.a.bufferWidthLength,height:n.a.bufferHeightLength,border:0,format:f.a.RGBA,type:p.a.Float,magFilter:x.a.Nearest,minFilter:x.a.Nearest,wrapS:x.a.Repeat,wrapT:x.a.Repeat,generateMipmap:!1,anisotropy:!1}):this.__dataTextureUid=this.__webglResourceRepository.createTexture(t,{level:0,internalFormat:f.a.RGBA,width:n.a.bufferWidthLength,height:n.a.bufferHeightLength,border:0,format:f.a.RGBA,type:p.a.Float,magFilter:x.a.Nearest,minFilter:x.a.Nearest,wrapS:x.a.Repeat,wrapT:x.a.Repeat,generateMipmap:!1,anisotropy:!1})},e.prototype.attachGPUData=function(e){var t=e.material,r=this.__webglResourceRepository.currentWebGLContextWrapper,a=r.getRawContext(),i=this.__webglResourceRepository.getWebGLResource(this.__dataTextureUid);r.bindTexture2D(0,i);var n=this.__webglResourceRepository.getWebGLResource(t._shaderProgramUid),o=a.getUniformLocation(n,"u_dataTexture");a.uniform1i(o,0)},e.prototype.attatchShaderProgram=function(e){var t=e._shaderProgramUid,r=this.__webglResourceRepository.currentWebGLContextWrapper.getRawContext(),a=this.__webglResourceRepository.getWebGLResource(t);r.useProgram(a)},e.prototype.attachVertexData=function(e,t,r,a){var i=this.__vertexHandles[e],n=this.__webglResourceRepository.getWebGLResource(i.vaoHandle),o=r.getRawContext();if(null!=n)r.bindVertexArray(n);else{this.__webglResourceRepository.setVertexDataToPipeline(i,t,a);var s=this.__webglResourceRepository.getWebGLResource(i.iboHandle);o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,s)}},e.getInstance=function(){return this.__instance||(this.__instance=new e),this.__instance},e.prototype.common_$render=function(e,t,r,a){var i=e.material,n=this.__webglResourceRepository.currentWebGLContextWrapper;this.attatchShaderProgram(i);n.getRawContext();var o=this.__webglResourceRepository.getWebGLResource(i._shaderProgramUid);return this.__webglResourceRepository.setUniformValue(o,m.a.ViewMatrix.str,!0,t),this.__webglResourceRepository.setUniformValue(o,m.a.ProjectionMatrix.str,!0,r),!0},e.__vertexHandleOfPrimitiveObjectUids=new Map,e}(),M=r(41),L=r(69),A=r(24),V=r(12),I=r(65),S=r(22),C=r(49),G=r(50),W=r(46),D=r(1),F=r(48),E=r(54),B=function(e,t,r,a){return new(r||(r=Promise))(function(i,n){function o(e){try{u(a.next(e))}catch(e){n(e)}}function s(e){try{u(a.throw(e))}catch(e){n(e)}}function u(e){e.done?i(e.value):new r(function(t){t(e.value)}).then(o,s)}u((a=a.apply(e,t||[])).next())})},N=function(e,t){var r,a,i,n,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return n={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(n[Symbol.iterator]=function(){return this}),n;function s(n){return function(s){return function(n){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,a&&(i=2&n[0]?a.return:n[0]?a.throw||((i=a.return)&&i.call(a),0):a.next)&&!(i=i.call(a,n[1])).done)return i;switch(a=0,i&&(n=[2&n[0],i.value]),n[0]){case 0:case 1:i=n;break;case 4:return o.label++,{value:n[1],done:!1};case 5:o.label++,a=n[1],n=[0];continue;case 7:n=o.ops.pop(),o.trys.pop();continue;default:if(!(i=(i=o.trys).length>0&&i[i.length-1])&&(6===n[0]||2===n[0])){o=0;continue}if(3===n[0]&&(!i||n[1]>i[0]&&n[1]<i[3])){o.label=n[1];break}if(6===n[0]&&o.label<i[1]){o.label=i[1],i=n;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(n);break}i[2]&&o.ops.pop(),o.trys.pop();continue}n=t.call(e,o)}catch(e){n=[6,e],a=0}finally{r=i=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([n,s])}}},H=function(){function e(){this.__webglResourceRepository=i.a.getInstance(),this.__lastRenderPassCullFace=!1,this.__pointDistanceAttenuation=new D.b(0,.1,.01),this.__lastRenderPassTickCount=-1,this.vertexShaderMethodDefinitions_uniform="\n  uniform mat4 u_worldMatrix;\n  uniform mat4 u_viewMatrix;\n  uniform mat4 u_projectionMatrix;\n  uniform mat3 u_normalMatrix;\n\n  mat4 getMatrix(float instanceId) {\n    return u_worldMatrix;\n  }\n\n  mat4 getViewMatrix(float instanceId) {\n    return u_viewMatrix;\n  }\n\n  mat4 getProjectionMatrix(float instanceId) {\n    return u_projectionMatrix;\n  }\n\n  mat3 getNormalMatrix(float instanceId) {\n    return u_normalMatrix;\n  }\n  ",this.__lastShader=-1}return e.prototype.setupShaderProgram=function(e){if(null!=e.mesh)for(var t=e.mesh.getPrimitiveNumber(),r=0;r<t;r++){var a=e.mesh.getPrimitiveAt(r),i=a.material;if(i){if(i._shaderProgramUid!==c.a.InvalidCGAPIResourceUid)return;var n=this.__webglResourceRepository.currentWebGLContextWrapper.getRawContext();i.createProgram(this.vertexShaderMethodDefinitions_uniform,m.a.getShaderProperty);var o=[{semantic:m.a.VertexAttributesExistenceArray,compositionType:d.a.ScalarArray,componentType:p.a.Int,stage:_.a.VertexShader,min:0,max:1,isPlural:!1,isSystem:!0,updateInteval:E.a.EveryTime},{semantic:m.a.WorldMatrix,compositionType:d.a.Mat4,componentType:p.a.Float,stage:_.a.VertexShader,min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isPlural:!1,isSystem:!0,updateInteval:E.a.EveryTime},{semantic:m.a.NormalMatrix,compositionType:d.a.Mat3,componentType:p.a.Float,stage:_.a.VertexShader,min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isPlural:!1,isSystem:!0,updateInteval:E.a.EveryTime},{semantic:m.a.ViewMatrix,compositionType:d.a.Mat4,componentType:p.a.Float,stage:_.a.VertexShader,min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isPlural:!1,isSystem:!0,updateInteval:E.a.FirstTimeOnly},{semantic:m.a.ProjectionMatrix,compositionType:d.a.Mat4,componentType:p.a.Float,stage:_.a.VertexShader,min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isPlural:!1,isSystem:!0,updateInteval:E.a.FirstTimeOnly},{semantic:m.a.ViewPosition,compositionType:d.a.Vec3,componentType:p.a.Float,stage:_.a.PixelShader,min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isPlural:!1,isSystem:!0,updateInteval:E.a.FirstTimeOnly},{semantic:m.a.BoneMatrix,compositionType:d.a.Mat4,componentType:p.a.Float,stage:_.a.VertexShader,min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isPlural:!0,isSystem:!0,updateInteval:E.a.EveryTime},{semantic:m.a.BoneCompressedChank,compositionType:d.a.Vec4Array,componentType:p.a.Float,stage:_.a.VertexShader,min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isPlural:!0,isSystem:!0,updateInteval:E.a.EveryTime},{semantic:m.a.BoneCompressedInfo,compositionType:d.a.Vec4,componentType:p.a.Float,stage:_.a.VertexShader,min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isPlural:!1,isSystem:!0,updateInteval:E.a.EveryTime},{semantic:m.a.SkinningMode,compositionType:d.a.Scalar,componentType:p.a.Int,stage:_.a.VertexShader,min:0,max:1,isPlural:!1,isSystem:!0,updateInteval:E.a.EveryTime},{semantic:m.a.DiffuseEnvTexture,compositionType:d.a.TextureCube,componentType:p.a.Int,stage:_.a.PixelShader,min:0,max:Number.MAX_SAFE_INTEGER,isPlural:!1,isSystem:!0,updateInteval:E.a.EveryTime},{semantic:m.a.SpecularEnvTexture,compositionType:d.a.TextureCube,componentType:p.a.Int,stage:_.a.PixelShader,min:0,max:Number.MAX_SAFE_INTEGER,isPlural:!1,isSystem:!0,updateInteval:E.a.EveryTime},{semantic:m.a.IBLParameter,compositionType:d.a.Vec4,componentType:p.a.Float,stage:_.a.PixelShader,min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isPlural:!1,isSystem:!0,updateInteval:E.a.EveryTime},{semantic:m.a.HDRIFormat,compositionType:d.a.Vec2,componentType:p.a.Int,stage:_.a.PixelShader,min:0,max:5,isPlural:!1,isSystem:!0,updateInteval:E.a.EveryTime},{semantic:m.a.BrdfLutTexture,compositionType:d.a.Texture2D,componentType:p.a.Int,stage:_.a.PixelShader,min:0,max:Number.MAX_SAFE_INTEGER,isPlural:!1,isSystem:!0,updateInteval:E.a.EveryTime},{semantic:m.a.LightNumber,compositionType:d.a.Scalar,componentType:p.a.Int,stage:_.a.PixelShader,min:0,max:Number.MAX_SAFE_INTEGER,isPlural:!1,isSystem:!0,updateInteval:E.a.FirstTimeOnly}];a.primitiveMode.index===n.POINTS&&o.push({semantic:m.a.PointSize,compositionType:d.a.Scalar,componentType:p.a.Float,stage:_.a.PixelShader,min:0,max:Number.MAX_VALUE,isPlural:!1,isSystem:!0,updateInteval:E.a.EveryTime},{semantic:m.a.PointDistanceAttenuation,compositionType:d.a.Vec3,componentType:p.a.Float,stage:_.a.PixelShader,min:0,max:1,isPlural:!1,isSystem:!0,updateInteval:E.a.EveryTime});for(var s=[],u=0;u<S.a.maxLightNumberInShader;u++)s.push({semantic:m.a.LightPosition,compositionType:d.a.Vec4,componentType:p.a.Float,stage:_.a.PixelShader,min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isPlural:!1,prefix:"lights["+u+"].",index:u,isSystem:!0,updateInteval:E.a.EveryTime}),s.push({semantic:m.a.LightDirection,compositionType:d.a.Vec4,componentType:p.a.Float,stage:_.a.PixelShader,min:-1,max:1,isPlural:!1,prefix:"lights["+u+"].",index:u,isSystem:!0,updateInteval:E.a.EveryTime}),s.push({semantic:m.a.LightIntensity,compositionType:d.a.Vec4,componentType:p.a.Float,stage:_.a.PixelShader,min:0,max:10,isPlural:!1,prefix:"lights["+u+"].",index:u,isSystem:!0});o=o.concat(s),this.__webglShaderProgram=this.__webglResourceRepository.setupUniformLocations(i._shaderProgramUid,o),i.setUniformLocations(i._shaderProgramUid)}}else l.a.alertNoMeshSet(e)},e.prototype.$load=function(e){return B(this,void 0,void 0,function(){var t,r,a,i;return N(this,function(n){switch(n.label){case 0:if(null==e.mesh)return l.a.alertNoMeshSet(e),[2];for(this.setupShaderProgram(e),t=e.mesh.getPrimitiveNumber(),r=0;r<t;r++)e.mesh.getPrimitiveAt(r).create3DAPIVertexData();return e.mesh.updateVariationVBO(),this.__dummyWhiteTextureUid=this.__webglResourceRepository.createDummyTexture(),this.__dummyBlackTextureUid=this.__webglResourceRepository.createDummyTexture("rgba(0, 0, 0, 1)"),this.__dummyBlackCubeTextureUid=this.__webglResourceRepository.createDummyCubeTexture(),a=C.a.getInstance().getModule("pbr").pbrCookTorranceBrdfLutDataUrl,i=this,[4,this.__webglResourceRepository.createTextureFromDataUri(a,{level:0,internalFormat:f.a.RGBA,border:0,format:f.a.RGBA,type:p.a.Float,magFilter:x.a.Linear,minFilter:x.a.Linear,wrapS:x.a.ClampToEdge,wrapT:x.a.ClampToEdge,generateMipmap:!1,anisotropy:!1})];case 1:return i.__pbrCookTorranceBrdfLutDataUrlUid=n.sent(),[2]}})})},e.prototype.$prerender=function(e,t,r){if(null!=e.mesh){var a=e.mesh.getPrimitiveNumber();if(e.mesh.weights.length>0)for(var i=0;i<a;i++){var n=e.mesh.getPrimitiveAt(i);this.__webglResourceRepository.resendVertexBuffer(n,n.vertexHandles.vboHandles)}for(i=0;i<a;i++){n=e.mesh.getPrimitiveAt(i);this.__webglResourceRepository.setVertexDataToPipeline({vaoHandle:e.mesh.getVaoUids(i),iboHandle:n.vertexHandles.iboHandle,vboHandles:n.vertexHandles.vboHandles},n,r)}}else l.a.alertNoMeshSet(e)},e.prototype.common_$prerender=function(){var e=V.a.getInstance();this.__lightComponents=e.getComponentsWithType(I.a)},e.prototype.attachGPUData=function(e){},e.prototype.attatchShaderProgram=function(e){},e.prototype.attachVertexData=function(e,t,r,a){},e.prototype.attachVertexDataInner=function(e,t,r,a,i){var n=t.vertexHandles,o=this.__webglResourceRepository.getWebGLResource(e.getVaoUids(r)),s=a.getRawContext();if(null!=o)a.bindVertexArray(o);else{this.__webglResourceRepository.setVertexDataToPipeline(n,t,i);var u=this.__webglResourceRepository.getWebGLResource(n.iboHandle);s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,u)}},e.prototype.dettachVertexData=function(e){var t=e.getRawContext();e.bindVertexArray&&e.bindVertexArray(null),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),t.bindBuffer(t.ARRAY_BUFFER,null)},e.getInstance=function(){return this.__instance||(this.__instance=new e),this.__instance},e.prototype.common_$render=function(e,t,r,a){return!1},e.isOpaqueMode=function(){return e.__isOpaqueMode},e.isTransparentMode=function(){return!e.__isOpaqueMode},e.prototype.__setUniformBySystem=function(t){var r=t.glw,a=t.shaderProgram,i=t.primitive,n=(t.shaderProgramUid,t.entity),o=t.worldMatrix,s=t.normalMatrix,u=t.renderPass,l=t.diffuseCube,c=t.specularCube,p=t.firstTime;this.__webglResourceRepository.setUniformValue(a,m.a.VertexAttributesExistenceArray.str,p,i.vertexHandles.attributesFlags),M.a.transposeTo(o,e.transposedMatrix44),this.__webglResourceRepository.setUniformValue(a,m.a.WorldMatrix.str,p,e.transposedMatrix44),this.__webglResourceRepository.setUniformValue(a,m.a.NormalMatrix.str,p,s);var d=u.cameraComponent;if(null==d&&(d=V.a.getInstance().getComponent(A.a,A.a.main)),d){this.__webglResourceRepository.setUniformValue(a,m.a.ViewMatrix.str,p,d.viewMatrix),this.__webglResourceRepository.setUniformValue(a,m.a.ProjectionMatrix.str,p,d.projectionMatrix);var _=d.worldPosition;this.__webglResourceRepository.setUniformValue(a,m.a.ViewPosition.str,p,_)}var h=n.getComponent(L.a);if(h){var g=h.jointMatrices,f=h.jointCompressedChanks;null!=g&&this.__webglResourceRepository.setUniformValue(a,m.a.BoneMatrix.str,p,g),null!=f&&(this.__webglResourceRepository.setUniformValue(a,m.a.BoneCompressedChank.str,p,f),this.__webglResourceRepository.setUniformValue(a,m.a.BoneCompressedInfo.str,p,h.jointCompressedInfo)),this.__webglResourceRepository.setUniformValue(a,m.a.SkinningMode.str,p,!0)}else this.__webglResourceRepository.setUniformValue(a,m.a.SkinningMode.str,p,!1);if(this.__webglResourceRepository.setUniformValue(a,m.a.DiffuseEnvTexture.str,p,[6,-1]))if(l&&l.isTextureReady){var x=this.__webglResourceRepository.getWebGLResource(l.cgApiResourceUid);r.bindTextureCube(6,x)}else{x=this.__webglResourceRepository.getWebGLResource(this.__dummyBlackCubeTextureUid);r.bindTextureCube(6,x)}if(this.__webglResourceRepository.setUniformValue(a,m.a.SpecularEnvTexture.str,p,[7,-1]))if(c&&c.isTextureReady){x=this.__webglResourceRepository.getWebGLResource(c.cgApiResourceUid);r.bindTextureCube(7,x)}else{x=this.__webglResourceRepository.getWebGLResource(this.__dummyBlackCubeTextureUid);r.bindTextureCube(7,x)}var b=1;c&&(b=c.mipmapLevelNumber);var y=n.getComponent(G.a);this.__webglResourceRepository.setUniformValue(a,m.a.IBLParameter.str,p,{x:b,y:y.diffuseCubeMapContribution,z:y.specularCubeMapContribution,w:y.rotationOfCubeMap});var R=F.a.LDR_SRGB.index,v=F.a.LDR_SRGB.index;if(y.diffuseCubeMap&&(R=y.diffuseCubeMap.hdriFormat.index),y.specularCubeMap&&(v=y.specularCubeMap.hdriFormat.index),this.__webglResourceRepository.setUniformValue(a,m.a.HDRIFormat.str,p,{x:R,y:v}),this.__webglResourceRepository.setUniformValue(a,m.a.BrdfLutTexture.str,p,[5,-1]))if(null!=this.__pbrCookTorranceBrdfLutDataUrlUid){x=this.__webglResourceRepository.getWebGLResource(this.__pbrCookTorranceBrdfLutDataUrlUid);r.bindTexture2D(5,x)}else{x=this.__webglResourceRepository.getWebGLResource(this.__dummyWhiteTextureUid);r.bindTexture2D(5,x)}this.__webglResourceRepository.setUniformValue(a,m.a.PointSize.str,p,{x:30}),this.__webglResourceRepository.setUniformValue(a,m.a.PointDistanceAttenuation.str,p,{x:this.__pointDistanceAttenuation.v}),this.__webglResourceRepository.setUniformValue(a,m.a.LightNumber.str,p,this.__lightComponents.length);for(var w=0;w<this.__lightComponents.length&&!(w>=S.a.maxLightNumberInShader);w++){var U=this.__lightComponents[w],T=U.entity.getSceneGraph().worldPosition,P=U.direction,I=U.intensity;this.__webglResourceRepository.setUniformValue(a,m.a.LightPosition.str,p,{x:T.x,y:T.y,z:T.z,w:U.type.index},w),this.__webglResourceRepository.setUniformValue(a,m.a.LightDirection.str,p,{x:P.x,y:P.y,z:P.z,w:0},w),this.__webglResourceRepository.setUniformValue(a,m.a.LightIntensity.str,p,{x:I.x,y:I.y,z:I.z,w:0},w)}},e.prototype.$render=function(t,r,a,i,n,o,s,u,m){var p=this.__webglResourceRepository.currentWebGLContextWrapper,d=p.getRawContext();if(this.setWebGLStates(t,d,o),null!=r.mesh){for(var _=r.mesh.getPrimitiveNumber(),h=0;h<_;h++){var g=r.mesh.getPrimitiveAt(h);if((!e.isOpaqueMode()||!g.isBlend())&&(!e.isTransparentMode()||!g.isOpaque())){this.attachVertexDataInner(r.mesh,g,h,p,c.a.InvalidCGAPIResourceUid);var f=g.material,x=this.__webglResourceRepository.getWebGLResource(f._shaderProgramUid),b=f._shaderProgramUid,y=!1;s!==this.__lastRenderPassTickCount&&(y=!0),b!==this.__lastShader&&(d.useProgram(x),this.__lastShader=b,y=!0),this.__setUniformBySystem({glw:p,shaderProgram:x,primitive:g,shaderProgramUid:b,entity:n,worldMatrix:a,normalMatrix:i,renderPass:o,diffuseCube:u,specularCube:m,firstTime:y}),f&&f.setUniformValues(y,{entity:n,lightComponents:this.__lightComponents,renderPass:o}),g.indicesAccessor?d.drawElements(g.primitiveMode.index,g.indicesAccessor.elementCount,g.indicesAccessor.componentType.index,0):d.drawArrays(g.primitiveMode.index,0,g.getVertexCountAsVerticesBased()),this.dettachVertexData(p)}}this.__lastRenderPassTickCount=s}else l.a.alertNoMeshSet(r)},e.prototype.setWebGLStates=function(t,r,a){0===t&&(r.disable(r.BLEND),r.enable(r.DEPTH_TEST),r.depthMask(!0),e.__isOpaqueMode=!0),t===G.a.firstTranparentIndex&&(r.enable(r.BLEND),r.blendFuncSeparate(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA,r.ONE,r.ONE),r.depthMask(!1),e.__isOpaqueMode=!1),a.cullface!==this.__lastRenderPassCullFace&&(a.cullface?r.enable(r.CULL_FACE):r.disable(r.CULL_FACE),this.__lastRenderPassCullFace=a.cullface)},e.__isOpaqueMode=!0,e.transposedMatrix44=new W.a([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),e}(),O=r(63),j=r(7),k=function(e){var t="function"==typeof Symbol&&e[Symbol.iterator],r=0;return t?t.call(e):{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}}},z=function(){function e(){this.__webglResourceRepository=i.a.getInstance(),this.__dataTextureUid=c.a.InvalidCGAPIResourceUid,this.__lastShader=c.a.InvalidCGAPIResourceUid}return Object.defineProperty(e.prototype,"vertexShaderMethodDefinitions_dataTexture",{get:function(){var e=w.a.getInstance().glsl_texture;return"\n  uniform sampler2D u_dataTexture;\n  uniform mat4 u_viewMatrix;\n  uniform mat4 u_projectionMatrix;\n  uniform mat3 u_normalMatrix;\n\n  /*\n   * This idea from https://qiita.com/YVT/items/c695ab4b3cf7faa93885\n   * arg = vec2(1. / size.x, 1. / size.x / size.y);\n   */\n  // vec4 fetchElement(sampler2D tex, float index, vec2 arg)\n  // {\n  //   return "+e+"( tex, arg * (index + 0.5) );\n  // }\n\n  vec4 fetchElement(sampler2D tex, float index, vec2 invSize)\n  {\n    float t = (index + 0.5) * invSize.x;\n    float x = fract(t);\n    float y = (floor(t) + 0.5) * invSize.y;\n    return "+e+"( tex, vec2(x, y) );\n  }\n\n  mat4 getMatrix(float instanceId)\n  {\n    float index = "+T.a.getLocationOffsetOfMemberOfComponent(s.a,"worldMatrix")+".0 + 4.0 * instanceId;\n    float powWidthVal = "+n.a.bufferWidthLength+".0;\n    float powHeightVal = "+n.a.bufferHeightLength+".0;\n    vec2 arg = vec2(1.0/powWidthVal, 1.0/powHeightVal);\n  //  vec2 arg = vec2(1.0/powWidthVal, 1.0/powWidthVal/powHeightVal);\n\n    vec4 col0 = fetchElement(u_dataTexture, index + 0.0, arg);\n    vec4 col1 = fetchElement(u_dataTexture, index + 1.0, arg);\n    vec4 col2 = fetchElement(u_dataTexture, index + 2.0, arg);\n\n    mat4 matrix = mat4(\n      col0.x, col1.x, col2.x, 0.0,\n      col0.y, col1.y, col2.y, 0.0,\n      col0.z, col1.z, col2.z, 0.0,\n      col0.w, col1.w, col2.w, 1.0\n      );\n\n    return matrix;\n  }\n\n  mat4 getViewMatrix(float instanceId) {\n    return u_viewMatrix;\n  }\n\n  mat4 getProjectionMatrix(float instanceId) {\n    return u_projectionMatrix;\n  }\n\n  mat3 getNormalMatrix(float instanceId) {\n    float index = "+T.a.getLocationOffsetOfMemberOfComponent(s.a,"normalMatrix")+".0 + 3.0 * instanceId;\n    float powWidthVal = "+n.a.bufferWidthLength+".0;\n    float powHeightVal = "+n.a.bufferHeightLength+".0;\n    vec2 arg = vec2(1.0/powWidthVal, 1.0/powHeightVal);\n  //  vec2 arg = vec2(1.0/powWidthVal, 1.0/powWidthVal/powHeightVal);\n\n    vec4 col0 = fetchElement(u_dataTexture, index + 0.0, arg);\n    vec4 col1 = fetchElement(u_dataTexture, index + 1.0, arg);\n    vec4 col2 = fetchElement(u_dataTexture, index + 2.0, arg);\n\n    mat3 matrix = mat3(\n      col0.x, col0.y, col0.z,\n      col0.w, col1.x, col1.y,\n      col1.z, col1.w, col2.x\n      );\n    // mat3 matrix = mat3(\n    //   col0.x, col0.w, col1.z,\n    //   col0.y, col1.x, col1.w,\n    //   col0.z, col1.y, col2.x\n    //   );\n\n\n    return matrix;\n  }\n\n  "},enumerable:!0,configurable:!0}),e.prototype.setupShaderProgram=function(e){if(null!=e.mesh)for(var t=function(e){var t=1;switch(e.compositionType){case d.a.Mat4:t=4;break;case d.a.Mat3:t=3}return t},r=function(e,r,a){var i,o=r.compositionType.getGlslStr(r.componentType),s=[],u=1,l=a;if(-1!==a.indexOf("___")){if(-1===a.indexOf("___0"))return"";for(var c=t(r),m=0;m<r.maxIndex;m++){var _=a.replace("___0","___"+m),h=O.a.getLocationOffsetOfMemberOfMaterial(e,_);s.push(h)}u=r.maxIndex,l=a.split("___")[0];var g="float indices["+u+"];";s.forEach(function(e,t){g+="\nindices["+t+"] = "+e+".0;"}),i="\n          "+g+"\n          float idx = 0.0;\n          for (int i=0; i<"+u+"; i++) {\n            idx = indices[i] + "+c+".0 * instanceId;\n            if (i == index) {\n              break;\n            }\n          }"}else{c=t(r);i="float idx = "+O.a.getLocationOffsetOfMemberOfMaterial(e,a)+".0 + "+c+".0 * instanceId;"}var f="\n      "+o+" get_"+(l=l.replace(".","_"))+"(float instanceId, const int index) {\n        "+i+"\n        float powWidthVal = "+n.a.bufferWidthLength+".0;\n        float powHeightVal = "+n.a.bufferHeightLength+".0;\n        vec2 arg = vec2(1.0/powWidthVal, 1.0/powHeightVal);\n        vec4 col0 = fetchElement(u_dataTexture, idx + 0.0, arg);\n";switch(r.compositionType){case d.a.Vec4:f+="        vec4 val = col0;";break;case d.a.Vec3:f+="        vec3 val = col0.xyz;";break;case d.a.Vec2:f+="        vec2 val = col0.xy;";break;case d.a.Scalar:if(r.componentType===p.a.Int){f+="        int val = int(col0.x);";break}f+="        float val = col0.x;";break;case d.a.Mat4:f+="\n          vec4 col1 = fetchElement(u_dataTexture, index + 1.0, arg);\n          vec4 col2 = fetchElement(u_dataTexture, index + 2.0, arg);\n          mat4 val = mat4(\n            col0.x, col1.x, col2.x, 0.0,\n            col0.y, col1.y, col2.y, 0.0,\n            col0.z, col1.z, col2.z, 0.0,\n            col0.w, col1.w, col2.w, 1.0\n            );\n          ";break;case d.a.Mat3:f+="\n          vec4 col1 = fetchElement(u_dataTexture, index + 1.0, arg);\n          vec4 col2 = fetchElement(u_dataTexture, index + 2.0, arg);\n          mat3 val = mat3(\n            col0.x, col0.w, col1.z,\n            col0.y, col1.x, col1.w,\n            col0.z, col1.y, col2.x,\n            );\n          ";break;default:return console.error("unknown composition type",r.compositionType.str,a),""}return f+="\n          return val;\n        }\n      "},a=e.mesh.getPrimitiveNumber(),i=0;i<a;i++){var o=e.mesh.getPrimitiveAt(i).material;if(o){if(o._shaderProgramUid!==c.a.InvalidCGAPIResourceUid)return;o.createProgram(this.vertexShaderMethodDefinitions_dataTexture,r),this.__webglResourceRepository.setupUniformLocations(o._shaderProgramUid,[{semantic:m.a.ViewMatrix,compositionType:d.a.Mat4,componentType:p.a.Float,stage:_.a.VertexShader,min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isPlural:!1,isSystem:!0},{semantic:m.a.ProjectionMatrix,compositionType:d.a.Mat4,componentType:p.a.Float,stage:_.a.VertexShader,min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isPlural:!1,isSystem:!0}]),o.setUniformLocations(o._shaderProgramUid)}}else l.a.alertNoMeshSet(e)},e.prototype.__isLoaded=function(e){if(null==e.mesh)return!1;if(e.mesh.variationVBOUid!==c.a.InvalidCGAPIResourceUid){for(var t=e.mesh.getPrimitiveNumber(),r=0,a=0;a<t;a++){null!=e.mesh.getPrimitiveAt(a).vertexHandles&&r++}return t===r}return!1},e.prototype.$load=function(e){if(!this.__isLoaded(e))if(null!=e.mesh){this.setupShaderProgram(e);for(var t=e.mesh.getPrimitiveNumber(),r=0;r<t;r++){e.mesh.getPrimitiveAt(r).create3DAPIVertexData()}e.mesh.updateVariationVBO()}else l.a.alertNoMeshSet(e)},e.prototype.$prerender=function(e,t,r){if(!t._readyForRendering)if(null!=e.mesh)if(e.mesh.isInstanceMesh())t._readyForRendering=!0;else{for(var a=e.mesh.getPrimitiveNumber(),i=0;i<a;i++){var n=e.mesh.getPrimitiveAt(i);this.__webglResourceRepository.setVertexDataToPipeline({vaoHandle:e.mesh.getVaoUids(i),iboHandle:n.vertexHandles.iboHandle,vboHandles:n.vertexHandles.vboHandles},n,e.mesh.variationVBOUid)}t._readyForRendering=!0}else l.a.alertNoMeshSet(e)},e.prototype.common_$prerender=function(){var e=n.a.getInstance().getBuffer(u.a.GPUInstanceData),t=new Float32Array(e.getArrayBuffer());if(this.__dataTextureUid!==c.a.InvalidCGAPIResourceUid)return this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2,void this.__webglResourceRepository.updateTexture(this.__dataTextureUid,t,{level:0,width:n.a.bufferWidthLength,height:e.takenSizeInByte/n.a.bufferWidthLength/4,format:f.a.RGBA,type:p.a.Float});this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2?this.__dataTextureUid=this.__webglResourceRepository.createTexture(t,{level:0,internalFormat:x.a.RGBA32F,width:n.a.bufferWidthLength,height:n.a.bufferHeightLength,border:0,format:f.a.RGBA,type:p.a.Float,magFilter:x.a.Nearest,minFilter:x.a.Nearest,wrapS:x.a.Repeat,wrapT:x.a.Repeat,generateMipmap:!1,anisotropy:!1}):this.__dataTextureUid=this.__webglResourceRepository.createTexture(t,{level:0,internalFormat:f.a.RGBA,width:n.a.bufferWidthLength,height:n.a.bufferHeightLength,border:0,format:f.a.RGBA,type:p.a.Float,magFilter:x.a.Nearest,minFilter:x.a.Nearest,wrapS:x.a.Repeat,wrapT:x.a.Repeat,generateMipmap:!1,anisotropy:!1});var r=V.a.getInstance();this.__lightComponents=r.getComponentsWithType(I.a)},e.prototype.attachGPUData=function(e){var t=e.material,r=this.__webglResourceRepository.currentWebGLContextWrapper,a=r.getRawContext(),i=this.__webglResourceRepository.getWebGLResource(this.__dataTextureUid);r.bindTexture2D(0,i);var n=this.__webglResourceRepository.getWebGLResource(t._shaderProgramUid),o=a.getUniformLocation(n,"u_dataTexture");a.uniform1i(o,0)},e.prototype.attachGPUDataInner=function(e,t){this.__webglResourceRepository.bindTexture2D(0,this.__dataTextureUid);var r=e.getUniformLocation(t,"u_dataTexture");e.uniform1i(r,0)},e.prototype.attatchShaderProgram=function(e){var t=e._shaderProgramUid;if(t!==this.__lastShader){var r=this.__webglResourceRepository.currentWebGLContextWrapper.getRawContext(),a=this.__webglResourceRepository.getWebGLResource(t);r.useProgram(a),this.__lastShader=t}},e.prototype.attachVertexData=function(e,t,r,a){},e.prototype.attachVertexDataInner=function(e,t,r,a,i){var n=t.vertexHandles,o=this.__webglResourceRepository.getWebGLResource(e.getVaoUids(r)),s=a.getRawContext();if(null!=o)a.bindVertexArray(o);else{this.__webglResourceRepository.setVertexDataToPipeline(n,t,e.variationVBOUid);var u=this.__webglResourceRepository.getWebGLResource(n.iboHandle);s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,u)}},e.getInstance=function(){return this.__instance||(this.__instance=new e),this.__instance},e.prototype.__setupMaterial=function(e,t){e.setParameter(m.a.LightNumber,this.__lightComponents.length);for(var r=0;r<this.__lightComponents.length&&!(r>=S.a.maxLightNumberInShader);r++){var a=this.__lightComponents[r],i=a.entity.getSceneGraph().worldPosition,n=a.direction,o=a.intensity;e.setParameter(m.a.LightPosition,new j.b(i.x,i.y,i.z,a.type.index),r),e.setParameter(m.a.LightDirection,n,r),e.setParameter(m.a.LightIntensity,o,r)}},e.prototype.__setupMaterialEveryFrame=function(e,t){var r=t.cameraComponent;if(null==r&&(r=V.a.getInstance().getComponent(A.a,A.a.main)),r){var a=r.worldPosition;e.setParameter(m.a.ViewPosition,a)}},e.prototype.common_$render=function(t,r,a,i){var n,o,s=this.__webglResourceRepository.currentWebGLContextWrapper,u=s.getRawContext();try{for(var l=k(i.meshComponents),c=l.next();!c.done;c=l.next()){var p=c.value.mesh;if(p&&p.isOriginalMesh())for(var d=p.getPrimitiveNumber(),_=0;_<d;_++){var h=p.getPrimitiveAt(_),g=h.material._shaderProgramUid;if(-1!==g){if(this.attachVertexDataInner(p,h,_,s,p.variationVBOUid),g!==this.__lastShader){var f=this.__webglResourceRepository.getWebGLResource(g);u.useProgram(f);var x=u.getUniformLocation(f,"u_dataTexture");u.uniform1i(x,7),this.__materialSIDLocation=u.getUniformLocation(f,"u_materialSID"),this.__setupMaterial(h.material,i),e.__shaderProgram=f}u.uniform1f(this.__materialSIDLocation,h.material.materialSID),this.__webglResourceRepository.bindTexture2D(7,this.__dataTextureUid),this.__setupMaterialEveryFrame(h.material,i),h.material.setUniformValuesForOnlyTextures(!0),h.indicesAccessor?s.drawElementsInstanced(h.primitiveMode.index,h.indicesAccessor.elementCount,h.indicesAccessor.componentType.index,0,p.instanceCountIncludeOriginal):s.drawArraysInstanced(h.primitiveMode.index,0,h.getVertexCountAsVerticesBased(),p.instanceCountIncludeOriginal),this.__lastShader=g}}}}catch(e){n={error:e}}finally{try{c&&!c.done&&(o=l.return)&&o.call(l)}finally{if(n)throw n.error}}var b=e.__shaderProgram;return this.__webglResourceRepository.setUniformValue(b,m.a.ViewMatrix.str,!0,r),this.__webglResourceRepository.setUniformValue(b,m.a.ProjectionMatrix.str,!0,a),!1},e}(),X=function(e){return e.index===a.a.FastestWebGL1.index?z.getInstance():e.index===a.a.UBOWebGL2.index?h.getInstance():e.index===a.a.TransformFeedbackWebGL2.index?U.getInstance():e.index===a.a.UniformWebGL1.index||e.index===a.a.UniformWebGL2.index?H.getInstance():P.getInstance()},$=r(39),q=r(71),Y=Object.freeze({getRenderingStrategy:X,GLSLShader:$.a,WebGLContextWrapper:q.a,WebGLResourceRepository:i.a,WebGLStrategyDataTexture:P,WebGLStrategyTransformFeedback:U,WebGLStrategyUBO:h,WebGLStrategyUniform:H});t.default=Y}}]);