(window.webpackJsonp=window.webpackJsonp||[]).push([["webgl"],{67:function(e,t,r){"use strict";r.r(t);var i=r(46),a=r(26),o=r(22),n=r(27),s=r(21),u=r(8),c=r(9),l=r(6),_=function(){function e(){this.__webglResourceRepository=a.a.getInstance(),this.__uboUid=c.a.InvalidCGAPIResourceUid,this.__vertexHandles=[],this.__isVAOSet=!1,this.vertexShaderMethodDefinitions_UBO="layout (std140) uniform matrix {\n    mat4 world[1024];\n  } u_matrix;\n\n  uniform mat4 u_viewMatrix;\n  uniform mat4 u_projectionMatrix;\n  uniform mat3 u_normalMatrix;\n\n  mat4 getMatrix(float instanceId) {\n    float index = instanceId;\n    return transpose(u_matrix.world[int(index)]);\n  }\n\n  mat4 getViewMatrix(float instanceId) {\n    return u_viewMatrix;\n  }\n\n  mat4 getProjectionMatrix(float instanceId) {\n    return u_projectionMatrix;\n  }\n\n  mat3 getNormalMatrix(float instanceId) {\n    return u_normalMatrix;\n  }\n\n  "}return e.prototype.setupShaderProgram=function(e){for(var t=e.getPrimitiveNumber(),r=0;r<t;r++){var i=e.getPrimitiveAt(r).material;if(i){if(i._shaderProgramUid!==c.a.InvalidCGAPIResourceUid)return;i.createProgram(this.vertexShaderMethodDefinitions_UBO),this.__webglResourceRepository.setupUniformLocations(i._shaderProgramUid,[{semantic:l.a.ViewMatrix,isPlural:!1,isSystem:!0},{semantic:l.a.ProjectionMatrix,isPlural:!1,isSystem:!0}])}}},e.prototype.__isLoaded=function(e){return null!=this.__vertexHandles[e]},e.prototype.$load=function(t){if(!this.__isLoaded(0)){this.setupShaderProgram(t);for(var r=t.getPrimitiveNumber(),i=0;i<r;i++){var a=t.getPrimitiveAt(i),o=this.__webglResourceRepository.createVertexDataResources(a);this.__vertexHandles[i]=o,e.__vertexHandleOfPrimitiveObjectUids.set(a.objectUid,o)}}},e.prototype.$prerender=function(t,r){if(!this.__isVAOSet){for(var i=t.getPrimitiveNumber(),a=0;a<i;a++){var o=t.getPrimitiveAt(a);this.__vertexHandles[a]=e.__vertexHandleOfPrimitiveObjectUids.get(o.objectUid),this.__webglResourceRepository.setVertexDataToPipeline(this.__vertexHandles[a],o,r)}this.__isVAOSet=!0}},e.prototype.common_$prerender=function(){var e=o.a.getInstance().getBuffer(u.a.GPUInstanceData);new Float32Array(e.getArrayBuffer());this.__uboUid===c.a.InvalidCGAPIResourceUid?(this.__uboUid=this.__webglResourceRepository.createUniformBuffer(s.a.getAccessor("worldMatrix",s.a).dataViewOfBufferView),this.__webglResourceRepository.bindUniformBufferBase(0,this.__uboUid)):this.__webglResourceRepository.updateUniformBuffer(this.__uboUid,s.a.getAccessor("worldMatrix",s.a).dataViewOfBufferView)},e.prototype.attachGPUData=function(e){this.__webglResourceRepository.bindUniformBlock(e.material._shaderProgramUid,"matrix",0)},e.prototype.attatchShaderProgram=function(e){var t=e._shaderProgramUid,r=this.__webglResourceRepository.currentWebGLContextWrapper.getRawContext(),i=this.__webglResourceRepository.getWebGLResource(t);r.useProgram(i)},e.prototype.attachVertexData=function(e,t,r,i){var a=this.__vertexHandles[e],o=this.__webglResourceRepository.getWebGLResource(a.vaoHandle),n=r.getRawContext();if(null!=o)r.bindVertexArray(o);else{this.__webglResourceRepository.setVertexDataToPipeline(a,t,i);var s=this.__webglResourceRepository.getWebGLResource(a.iboHandle);n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,s)}},e.getInstance=function(){return this.__instance||(this.__instance=new e),this.__instance},e.prototype.common_$render=function(e,t,r){var i=this.__webglResourceRepository.currentWebGLContextWrapper,a=e.material;this.attatchShaderProgram(a);i.getRawContext();return this.__webglResourceRepository.setUniformValue(a._shaderProgramUid,l.a.ViewMatrix,!0,4,"f",!0,{x:t.v},{}),this.__webglResourceRepository.setUniformValue(a._shaderProgramUid,l.a.ProjectionMatrix,!0,4,"f",!0,{x:r.v},{}),!0},e.__vertexHandleOfPrimitiveObjectUids=new Map,e}(),p=r(35),d=r(37),h=r(2),m=r(23),f=r(40),g=r(20),R=r(34),b=r(1),x=r(3),y=r(16),v=r(56),w=function(){function e(){this.__webglResourceRepository=a.a.getInstance(),this.__instanceDataTextureUid=c.a.InvalidCGAPIResourceUid,this.__vertexDataTextureUid=c.a.InvalidCGAPIResourceUid,this.__primitiveHeaderUboUid=c.a.InvalidCGAPIResourceUid,this.__indexCountToSubtractUboUid=c.a.InvalidCGAPIResourceUid,this.__entitiesUidUboUid=c.a.InvalidCGAPIResourceUid,this.__primitiveUidUboUid=c.a.InvalidCGAPIResourceUid,this.__isVertexReady=!1}return Object.defineProperty(e.prototype,"__transformFeedbackShaderText",{get:function(){v.a.getInstance().glsl_vertex_in,v.a.getInstance().glsl_texture;return"\n    uniform mat4 u_worldMatrix;\n    uniform mat4 u_viewMatrix;\n    uniform mat4 u_projectionMatrix;\n    uniform mat3 u_normalMatrix;\n\n    mat4 getMatrix(float instanceId) {\n      return u_worldMatrix;\n    }\n\n    mat4 getViewMatrix(float instanceId) {\n      return u_viewMatrix;\n    }\n\n    mat4 getProjectionMatrix(float instanceId) {\n      return u_projectionMatrix;\n    }\n\n    mat3 getNormalMatrix(float instanceId) {\n      return u_normalMatrix;\n    }\n\n    layout (std140) uniform indexCountsToSubtract {\n      ivec4 counts[256];\n    } u_indexCountsToSubtract;\n    layout (std140) uniform entityUids {\n      ivec4 ids[256];\n    } u_entityData;\n    layout (std140) uniform primitiveUids {\n      ivec4 ids[256];\n    } u_primitiveData;\n    layout (std140) uniform primitiveHeader {\n      ivec4 data[256];\n    } u_primitiveHeader;\n\n    out vec4 position;\n    //out vec3 colors;\n\n    uniform sampler2D u_instanceDataTexture;\n    uniform sampler2D u_vertexDataTexture;\n\n    // void main(){\n    //   int indexOfVertices = gl_VertexID + 3*gl_InstanceID;\n\n    //   int entityUidMinusOne = 0;\n    //   int primitiveUid = 0;\n    //   for (int i=0; i<=indexOfVertices; i++) {\n    //     for (int j=0; j<1024; j++) {\n    //       int value = u_indexCountsToSubtract.counts[j/4][j%4];\n    //       int result = int(step(float(value), float(i)));\n    //       if (result > 0) {\n    //         entityUidMinusOne = result * int(u_entityData.ids[j/4][j%4]) - 1;\n    //         primitiveUid = result * u_primitiveData.ids[j/4][j%4];\n    //       } else {\n    //         break;\n    //       }\n    //     }\n    //   }\n\n    //   ivec4 indicesMeta = u_primitiveHeader.data[9*primitiveUid + 0];\n    //   int primIndicesByteOffset = indicesMeta.x;\n    //   int primIndicesComponentSizeInByte = indicesMeta.y;\n    //   int primIndicesLength = indicesMeta.z;\n\n    //   int idx = gl_VertexID - primIndicesByteOffset / 4 /*byte*/;\n\n    //   // get Indices\n    //   int texelLength = "+o.a.bufferWidthLength+";\n    //   vec4 indexVec4 = texelFetch(u_vertexDataTexture, ivec2(idx%texelLength, idx/texelLength), 0);\n    //   int index = int(indexVec4[idx%4]);\n\n    //   // get Positions\n    //   ivec4 indicesData = u_primitiveHeader.data[9*primitiveUid + 1];\n    //   int primPositionsByteOffset = indicesData.x;\n    //   idx = primPositionsByteOffset/4 + index;\n    //   vec4 posVec4 = texelFetch(u_vertexDataTexture, ivec2(idx%texelLength, idx/texelLength), 0);\n\n    //   position = posVec4;\n    //}\n"},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"__transformFeedbackFragmentShaderText",{get:function(){return"#version 300 es\nprecision highp float;\n\nout vec4 outColor;\n\nvoid main(){\n    outColor = vec4(1.0);\n}\n    "},enumerable:!0,configurable:!0}),e.prototype.setupShaderProgram=function(e){for(var t=e.getPrimitiveNumber(),r=0;r<t;r++){var i=e.getPrimitiveAt(r).material;if(i){if(i._shaderProgramUid!==c.a.InvalidCGAPIResourceUid)return;i.createProgram(this.__transformFeedbackShaderText),this.__webglResourceRepository.setupUniformLocations(i._shaderProgramUid,[{semantic:l.a.ViewMatrix,isPlural:!1,isSystem:!0},{semantic:l.a.ProjectionMatrix,isPlural:!1,isSystem:!0}])}}},e.prototype.$load=function(e){if(!this.__isVertexReady){this.setupShaderProgram(e);var t=o.a.getInstance().getBuffer(u.a.CPUGeneric),r=t.takeBufferView({byteLengthToNeed:12,byteStride:4,isAoS:!1}).takeAccessor({compositionType:b.a.Scalar,componentType:h.a.UnsingedInt,count:3}),i=t.takeBufferView({byteLengthToNeed:48,byteStride:16,isAoS:!1}).takeAccessor({compositionType:b.a.Vec4,componentType:h.a.Float,count:3}),a=r.getTypedArray();a[0]=0,a[1]=1,a[2]=2;var n=R.a.createPrimitive({indices:a,attributeCompositionTypes:[i.compositionType],attributeSemantics:[x.a.Position],attributes:[i.getTypedArray()],primitiveMode:y.a.Triangles,material:void 0});this.__vertexHandle=this.__webglResourceRepository.createVertexDataResources(n),this.__isVertexReady=!0}},e.prototype.$prerender=function(e,t){},e.prototype.__setupUBOPrimitiveHeaderData=function(){var e=o.a.getInstance().getBuffer(u.a.UBOGeneric),t=new Int32Array(e.getArrayBuffer());this.__primitiveHeaderUboUid===c.a.InvalidCGAPIResourceUid&&(this.__primitiveHeaderUboUid=this.__webglResourceRepository.createUniformBuffer(t),this.__webglResourceRepository.bindUniformBufferBase(3,this.__primitiveHeaderUboUid))},e.prototype.__setupGPUInstanceMetaData=function(){if(this.__primitiveUidUboUid===c.a.InvalidCGAPIResourceUid){var e=f.a.getInstance()._getEntities(),t=new Int32Array(e.length),r=new Int32Array(e.length),i=new Int32Array(e.length),a=0;e.forEach(function(e,o){var n=e.getComponent(g.a);if(n){r[o]=n.getPrimitiveAt(0).primitiveUid,t[o]=e.entityUID;var s=n.getPrimitiveAt(0).indicesAccessor.elementCount;i[o]=a+s,a+=s}}),this.__indexCountToSubtractUboUid=this.__webglResourceRepository.createUniformBuffer(i),this.__webglResourceRepository.bindUniformBufferBase(0,this.__indexCountToSubtractUboUid),this.__entitiesUidUboUid=this.__webglResourceRepository.createUniformBuffer(t),this.__webglResourceRepository.bindUniformBufferBase(1,this.__entitiesUidUboUid),this.__primitiveUidUboUid=this.__webglResourceRepository.createUniformBuffer(r),this.__webglResourceRepository.bindUniformBufferBase(2,this.__primitiveUidUboUid)}},e.prototype.__setupGPUInstanceData=function(){var e=!1;(this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2||this.__webglResourceRepository.currentWebGLContextWrapper.isSupportWebGL1Extension(p.a.TextureHalfFloat))&&(e=!0);var t,r=o.a.getInstance().getBuffer(u.a.GPUInstanceData),i=new Float32Array(r.getArrayBuffer());if(e){t=new Uint16Array(i.length);var a=r.takenSizeInByte/4;a/=2;for(var s=0;s<a;s++)t[s]=n.a.toHalfFloat(i[s])}this.__instanceDataTextureUid===c.a.InvalidCGAPIResourceUid?e?this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2?this.__instanceDataTextureUid=this.__webglResourceRepository.createTexture(i,{level:0,internalFormat:m.a.RGBA16F,width:o.a.bufferWidthLength,height:o.a.bufferHeightLength,border:0,format:d.a.RGBA,type:h.a.Float,magFilter:m.a.Nearest,minFilter:m.a.Nearest,wrapS:m.a.Repeat,wrapT:m.a.Repeat,generateMipmap:!1,anisotropy:!1}):this.__instanceDataTextureUid=this.__webglResourceRepository.createTexture(t,{level:0,internalFormat:d.a.RGBA,width:o.a.bufferWidthLength,height:o.a.bufferHeightLength,border:0,format:d.a.RGBA,type:h.a.HalfFloat,magFilter:m.a.Nearest,minFilter:m.a.Nearest,wrapS:m.a.Repeat,wrapT:m.a.Repeat,generateMipmap:!1,anisotropy:!1}):this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2?this.__instanceDataTextureUid=this.__webglResourceRepository.createTexture(i,{level:0,internalFormat:m.a.RGBA32F,width:o.a.bufferWidthLength,height:o.a.bufferHeightLength,border:0,format:d.a.RGBA,type:h.a.Float,magFilter:m.a.Nearest,minFilter:m.a.Nearest,wrapS:m.a.Repeat,wrapT:m.a.Repeat,generateMipmap:!1,anisotropy:!1}):this.__instanceDataTextureUid=this.__webglResourceRepository.createTexture(i,{level:0,internalFormat:d.a.RGBA,width:o.a.bufferWidthLength,height:o.a.bufferHeightLength,border:0,format:d.a.RGBA,type:h.a.Float,magFilter:m.a.Nearest,minFilter:m.a.Nearest,wrapS:m.a.Repeat,wrapT:m.a.Repeat,generateMipmap:!1,anisotropy:!1}):e?this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2?this.__webglResourceRepository.updateTexture(this.__instanceDataTextureUid,i,{level:0,width:o.a.bufferWidthLength,height:o.a.bufferHeightLength,format:d.a.RGBA,type:h.a.Float}):this.__webglResourceRepository.updateTexture(this.__instanceDataTextureUid,t,{level:0,width:o.a.bufferWidthLength,height:o.a.bufferHeightLength,format:d.a.RGBA,type:h.a.HalfFloat}):(this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2,this.__webglResourceRepository.updateTexture(this.__instanceDataTextureUid,i,{level:0,width:o.a.bufferWidthLength,height:o.a.bufferHeightLength,format:d.a.RGBA,type:h.a.Float}))},e.prototype.__setupGPUVertexData=function(){if(this.__vertexDataTextureUid===c.a.InvalidCGAPIResourceUid){var e=o.a.getInstance().getBuffer(u.a.GPUVertexData),t=new Float32Array(e.getArrayBuffer());this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2?this.__vertexDataTextureUid=this.__webglResourceRepository.createTexture(t,{level:0,internalFormat:m.a.RGBA32F,width:o.a.bufferWidthLength,height:o.a.bufferHeightLength,border:0,format:d.a.RGBA,type:h.a.Float,magFilter:m.a.Nearest,minFilter:m.a.Nearest,wrapS:m.a.Repeat,wrapT:m.a.Repeat,generateMipmap:!1,anisotropy:!1}):this.__vertexDataTextureUid=this.__webglResourceRepository.createTexture(t,{level:0,internalFormat:d.a.RGBA,width:o.a.bufferWidthLength,height:o.a.bufferHeightLength,border:0,format:d.a.RGBA,type:h.a.Float,magFilter:m.a.Nearest,minFilter:m.a.Nearest,wrapS:m.a.Repeat,wrapT:m.a.Repeat,generateMipmap:!1,anisotropy:!1})}},e.prototype.common_$prerender=function(){this.__setupUBOPrimitiveHeaderData(),this.__setupGPUInstanceMetaData(),this.__setupGPUInstanceData(),this.__setupGPUVertexData()},e.prototype.attachGPUData=function(e){var t=e.material,r=this.__webglResourceRepository.currentWebGLContextWrapper.getRawContext(),i=this.__webglResourceRepository.getWebGLResource(this.__instanceDataTextureUid);r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,i);var a=this.__webglResourceRepository.getWebGLResource(t._shaderProgramUid),o=r.getUniformLocation(a,"u_instanceDataTexture");r.uniform1i(o,0);r=this.__webglResourceRepository.currentWebGLContextWrapper.getRawContext(),i=this.__webglResourceRepository.getWebGLResource(this.__vertexDataTextureUid);r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,i);a=this.__webglResourceRepository.getWebGLResource(t._shaderProgramUid);var n=r.getUniformLocation(a,"u_vertexDataTexture");r.uniform1i(n,1),this.__webglResourceRepository.bindUniformBlock(t._shaderProgramUid,"indexCountsToSubtract",0),this.__webglResourceRepository.bindUniformBlock(t._shaderProgramUid,"entityUids",1),this.__webglResourceRepository.bindUniformBlock(t._shaderProgramUid,"primitiveUids",2),this.__webglResourceRepository.bindUniformBlock(t._shaderProgramUid,"primitiveHeader",3)},e.prototype.attatchShaderProgram=function(e){var t=e._shaderProgramUid,r=this.__webglResourceRepository.currentWebGLContextWrapper.getRawContext(),i=this.__webglResourceRepository.getWebGLResource(t);r.useProgram(i)},e.prototype.attachVertexData=function(e,t,r,i){},e.getInstance=function(){return this.__instance||(this.__instance=new e),this.__instance},e.prototype.common_$render=function(e,t,r){var i=e.material,a=this.__webglResourceRepository.currentWebGLContextWrapper;this.attatchShaderProgram(e.material);a.getRawContext();return this.__webglResourceRepository.setUniformValue(i._shaderProgramUid,l.a.ViewMatrix,!0,4,"f",!0,{x:t.v},{}),this.__webglResourceRepository.setUniformValue(i._shaderProgramUid,l.a.ProjectionMatrix,!0,4,"f",!0,{x:r.v},{}),!0},e}(),U=function(){function e(){this.__webglResourceRepository=a.a.getInstance(),this.__dataTextureUid=c.a.InvalidCGAPIResourceUid,this.__vertexHandles=[],this.__isVAOSet=!1}return Object.defineProperty(e.prototype,"vertexShaderMethodDefinitions_dataTexture",{get:function(){var e=v.a.getInstance().glsl_texture;return"\n  uniform sampler2D u_dataTexture;\n  uniform mat4 u_viewMatrix;\n  uniform mat4 u_projectionMatrix;\n  uniform mat3 u_normalMatrix;\n\n  /*\n   * This idea from https://qiita.com/YVT/items/c695ab4b3cf7faa93885\n   * arg = vec2(1. / size.x, 1. / size.x / size.y);\n   */\n  // vec4 fetchElement(sampler2D tex, float index, vec2 arg)\n  // {\n  //   return "+e+"( tex, arg * (index + 0.5) );\n  // }\n\n  vec4 fetchElement(sampler2D tex, float index, vec2 invSize)\n  {\n    float t = (index + 0.5) * invSize.x;\n    float x = fract(t);\n    float y = (floor(t) + 0.5) * invSize.y;\n    return "+e+"( tex, vec2(x, y) );\n  }\n\n  mat4 getMatrix(float instanceId)\n  {\n    float index = instanceId;\n    float powWidthVal = "+o.a.bufferWidthLength+".0;\n    float powHeightVal = "+o.a.bufferHeightLength+".0;\n    vec2 arg = vec2(1.0/powWidthVal, 1.0/powHeightVal);\n  //  vec2 arg = vec2(1.0/powWidthVal, 1.0/powWidthVal/powHeightVal);\n\n    vec4 col0 = fetchElement(u_dataTexture, index * 4.0 + 0.0, arg);\n   vec4 col1 = fetchElement(u_dataTexture, index * 4.0 + 1.0, arg);\n   vec4 col2 = fetchElement(u_dataTexture, index * 4.0 + 2.0, arg);\n\n    mat4 matrix = mat4(\n      col0.x, col1.x, col2.x, 0.0,\n      col0.y, col1.y, col2.y, 0.0,\n      col0.z, col1.z, col2.z, 0.0,\n      col0.w, col1.w, col2.w, 1.0\n      );\n\n    return matrix;\n  }\n\n  mat4 getViewMatrix(float instanceId) {\n    return u_viewMatrix;\n  }\n\n  mat4 getProjectionMatrix(float instanceId) {\n    return u_projectionMatrix;\n  }\n\n  mat3 getNormalMatrix(float instanceId) {\n    return u_normalMatrix;\n  }\n\n  "},enumerable:!0,configurable:!0}),e.prototype.setupShaderProgram=function(e){for(var t=e.getPrimitiveNumber(),r=0;r<t;r++){var i=e.getPrimitiveAt(r).material;if(i){if(i._shaderProgramUid!==c.a.InvalidCGAPIResourceUid)return;i.createProgram(this.vertexShaderMethodDefinitions_dataTexture),this.__webglResourceRepository.setupUniformLocations(i._shaderProgramUid,[{semantic:l.a.ViewMatrix,isPlural:!1,isSystem:!0},{semantic:l.a.ProjectionMatrix,isPlural:!1,isSystem:!0}])}}},e.prototype.__isLoaded=function(e){return null!=this.__vertexHandles[e]},e.prototype.$load=function(t){if(!this.__isLoaded(0)){this.__meshComponent=t,this.setupShaderProgram(t);for(var r=t.getPrimitiveNumber(),i=0;i<r;i++){var a=t.getPrimitiveAt(i),o=this.__webglResourceRepository.createVertexDataResources(a);this.__vertexHandles[i]=o,e.__vertexHandleOfPrimitiveObjectUids.set(a.objectUid,o)}}},e.prototype.$prerender=function(t,r){if(!this.__isVAOSet){for(var i=t.getPrimitiveNumber(),a=0;a<i;a++){var o=t.getPrimitiveAt(a);this.__vertexHandles[a]=e.__vertexHandleOfPrimitiveObjectUids.get(o.objectUid),this.__webglResourceRepository.setVertexDataToPipeline(this.__vertexHandles[a],o,r)}this.__isVAOSet=!0}},e.prototype.common_$prerender=function(){var e=!1;(this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2||this.__webglResourceRepository.currentWebGLContextWrapper.isSupportWebGL1Extension(p.a.TextureHalfFloat))&&(e=!0);var t,r=o.a.getInstance().getBuffer(u.a.GPUInstanceData),i=new Float32Array(r.getArrayBuffer());if(e){t=new Uint16Array(i.length);var a=r.takenSizeInByte/4;a/=2;for(var s=0;s<a;s++)t[s]=n.a.toHalfFloat(i[s])}this.__dataTextureUid===c.a.InvalidCGAPIResourceUid?e?this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2?this.__dataTextureUid=this.__webglResourceRepository.createTexture(i,{level:0,internalFormat:m.a.RGBA16F,width:o.a.bufferWidthLength,height:o.a.bufferHeightLength,border:0,format:d.a.RGBA,type:h.a.Float,magFilter:m.a.Nearest,minFilter:m.a.Nearest,wrapS:m.a.Repeat,wrapT:m.a.Repeat,generateMipmap:!1,anisotropy:!1}):this.__dataTextureUid=this.__webglResourceRepository.createTexture(t,{level:0,internalFormat:d.a.RGBA,width:o.a.bufferWidthLength,height:o.a.bufferHeightLength,border:0,format:d.a.RGBA,type:h.a.HalfFloat,magFilter:m.a.Nearest,minFilter:m.a.Nearest,wrapS:m.a.Repeat,wrapT:m.a.Repeat,generateMipmap:!1,anisotropy:!1}):this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2?this.__dataTextureUid=this.__webglResourceRepository.createTexture(i,{level:0,internalFormat:m.a.RGBA32F,width:o.a.bufferWidthLength,height:o.a.bufferHeightLength,border:0,format:d.a.RGBA,type:h.a.Float,magFilter:m.a.Nearest,minFilter:m.a.Nearest,wrapS:m.a.Repeat,wrapT:m.a.Repeat,generateMipmap:!1,anisotropy:!1}):this.__dataTextureUid=this.__webglResourceRepository.createTexture(i,{level:0,internalFormat:d.a.RGBA,width:o.a.bufferWidthLength,height:o.a.bufferHeightLength,border:0,format:d.a.RGBA,type:h.a.Float,magFilter:m.a.Nearest,minFilter:m.a.Nearest,wrapS:m.a.Repeat,wrapT:m.a.Repeat,generateMipmap:!1,anisotropy:!1}):e?this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2?this.__webglResourceRepository.updateTexture(this.__dataTextureUid,i,{level:0,width:o.a.bufferWidthLength,height:r.takenSizeInByte/o.a.bufferWidthLength/4,format:d.a.RGBA,type:h.a.Float}):this.__webglResourceRepository.updateTexture(this.__dataTextureUid,t,{level:0,width:o.a.bufferWidthLength,height:r.takenSizeInByte/o.a.bufferWidthLength/4,format:d.a.RGBA,type:h.a.HalfFloat}):(this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2,this.__webglResourceRepository.updateTexture(this.__dataTextureUid,i,{level:0,width:o.a.bufferWidthLength,height:r.takenSizeInByte/o.a.bufferWidthLength/4,format:d.a.RGBA,type:h.a.Float}))},e.prototype.attachGPUData=function(e){var t=e.material,r=this.__webglResourceRepository.currentWebGLContextWrapper.getRawContext(),i=this.__webglResourceRepository.getWebGLResource(this.__dataTextureUid);r.bindTexture(r.TEXTURE_2D,i);var a=this.__webglResourceRepository.getWebGLResource(t._shaderProgramUid),o=r.getUniformLocation(a,"u_dataTexture");r.uniform1i(o,0)},e.prototype.attatchShaderProgram=function(e){var t=e._shaderProgramUid,r=this.__webglResourceRepository.currentWebGLContextWrapper.getRawContext(),i=this.__webglResourceRepository.getWebGLResource(t);r.useProgram(i)},e.prototype.attachVertexData=function(e,t,r,i){var a=this.__vertexHandles[e],o=this.__webglResourceRepository.getWebGLResource(a.vaoHandle),n=r.getRawContext();if(null!=o)r.bindVertexArray(o);else{this.__webglResourceRepository.setVertexDataToPipeline(a,t,i);var s=this.__webglResourceRepository.getWebGLResource(a.iboHandle);n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,s)}},e.getInstance=function(){return this.__instance||(this.__instance=new e),this.__instance},e.prototype.common_$render=function(e,t,r){var i=e.material,a=this.__webglResourceRepository.currentWebGLContextWrapper;this.attatchShaderProgram(i);a.getRawContext();return this.__webglResourceRepository.setUniformValue(i._shaderProgramUid,l.a.ViewMatrix,!0,4,"f",!0,{x:t.v},{}),this.__webglResourceRepository.setUniformValue(i._shaderProgramUid,l.a.ProjectionMatrix,!0,4,"f",!0,{x:r.v},{}),!0},e.__vertexHandleOfPrimitiveObjectUids=new Map,e}(),P=r(41),T=r(55),L=r(33),G=r(13),S=r(58),A=r(30),I=r(32),M=r(50),W=r(45),C=r(0),B=function(e,t,r,i){return new(r||(r=Promise))(function(a,o){function n(e){try{u(i.next(e))}catch(e){o(e)}}function s(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){e.done?a(e.value):new r(function(t){t(e.value)}).then(n,s)}u((i=i.apply(e,t||[])).next())})},V=function(e,t){var r,i,a,o,n={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(r)throw new TypeError("Generator is already executing.");for(;n;)try{if(r=1,i&&(a=2&o[0]?i.return:o[0]?i.throw||((a=i.return)&&a.call(i),0):i.next)&&!(a=a.call(i,o[1])).done)return a;switch(i=0,a&&(o=[2&o[0],a.value]),o[0]){case 0:case 1:a=o;break;case 4:return n.label++,{value:o[1],done:!1};case 5:n.label++,i=o[1],o=[0];continue;case 7:o=n.ops.pop(),n.trys.pop();continue;default:if(!(a=(a=n.trys).length>0&&a[a.length-1])&&(6===o[0]||2===o[0])){n=0;continue}if(3===o[0]&&(!a||o[1]>a[0]&&o[1]<a[3])){n.label=o[1];break}if(6===o[0]&&n.label<a[1]){n.label=a[1],a=o;break}if(a&&n.label<a[2]){n.label=a[2],n.ops.push(o);break}a[2]&&n.ops.pop(),n.trys.pop();continue}o=t.call(e,n)}catch(e){o=[6,e],i=0}finally{r=a=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}},D=function(){function e(){this.__webglResourceRepository=a.a.getInstance(),this.vertexShaderMethodDefinitions_uniform="\n  uniform mat4 u_worldMatrix;\n  uniform mat4 u_viewMatrix;\n  uniform mat4 u_projectionMatrix;\n  uniform mat3 u_normalMatrix;\n\n  mat4 getMatrix(float instanceId) {\n    return u_worldMatrix;\n  }\n\n  mat4 getViewMatrix(float instanceId) {\n    return u_viewMatrix;\n  }\n\n  mat4 getProjectionMatrix(float instanceId) {\n    return u_projectionMatrix;\n  }\n\n  mat3 getNormalMatrix(float instanceId) {\n    return u_normalMatrix;\n  }\n  ",this.__lastShader=-1}return e.prototype.setupShaderProgram=function(e){for(var t=e.getPrimitiveNumber(),r=0;r<t;r++){var i=e.getPrimitiveAt(r),a=i.material;if(a){if(a._shaderProgramUid!==c.a.InvalidCGAPIResourceUid)return;var o=this.__webglResourceRepository.currentWebGLContextWrapper.getRawContext();a.createProgram(this.vertexShaderMethodDefinitions_uniform);var n=[{semantic:l.a.WorldMatrix,isPlural:!1,isSystem:!0},{semantic:l.a.ViewMatrix,isPlural:!1,isSystem:!0},{semantic:l.a.ProjectionMatrix,isPlural:!1,isSystem:!0},{semantic:l.a.NormalMatrix,isPlural:!1,isSystem:!0},{semantic:l.a.BoneMatrix,isPlural:!0,isSystem:!0},{semantic:l.a.BoneCompressedChank,isPlural:!0,isSystem:!0},{semantic:l.a.BoneCompressedInfo,isPlural:!1,isSystem:!0},{semantic:l.a.LightNumber,isPlural:!1,isSystem:!0},{semantic:l.a.ViewPosition,isPlural:!1,isSystem:!0},{semantic:l.a.SkinningMode,compositionType:b.a.Scalar,componentType:h.a.Int,isPlural:!1,isSystem:!0},{semantic:l.a.DiffuseEnvTexture,compositionType:b.a.TextureCube,componentType:h.a.Int,isPlural:!1,isSystem:!0},{semantic:l.a.SpecularEnvTexture,compositionType:b.a.TextureCube,componentType:h.a.Int,isPlural:!1,isSystem:!0},{semantic:l.a.IBLParameter,compositionType:b.a.Vec4,componentType:h.a.Float,isPlural:!1,isSystem:!0},{semantic:l.a.BrdfLutTexture,compositionType:b.a.Texture2D,componentType:h.a.Int,isPlural:!1,isSystem:!0},{semantic:l.a.VertexAttributesExistenceArray,compositionType:b.a.Scalar,componentType:h.a.Int,isPlural:!1,isSystem:!0},{semantic:l.a.PointSize,compositionType:b.a.Scalar,componentType:h.a.Float,isPlural:!1,isSystem:!0},{semantic:l.a.PointDistanceAttenuation,compositionType:b.a.Vec3,componentType:h.a.Float,isPlural:!1,isSystem:!0}];i.primitiveMode.index===o.POINTS&&n.push({semantic:l.a.PointSize,compositionType:b.a.Scalar,componentType:h.a.Float,isPlural:!1,isSystem:!0});for(var s=[],u=0;u<A.a.maxLightNumberInShader;u++)s.push({semantic:l.a.LightPosition,isPlural:!1,prefix:"lights["+u+"].",index:u,isSystem:!0}),s.push({semantic:l.a.LightDirection,isPlural:!1,prefix:"lights["+u+"].",index:u,isSystem:!0}),s.push({semantic:l.a.LightIntensity,isPlural:!1,prefix:"lights["+u+"].",index:u,isSystem:!0});this.__webglResourceRepository.setupUniformLocations(a._shaderProgramUid,n.concat(s)),a.setUniformLocations(a._shaderProgramUid)}}},e.prototype.$load=function(t){return B(this,void 0,void 0,function(){var r,i,a,o,n,s;return V(this,function(u){switch(u.label){case 0:for(this.setupShaderProgram(t),r=t.getPrimitiveNumber(),i=0;i<r;i++)a=t.getPrimitiveAt(i),o=this.__webglResourceRepository.createVertexDataResources(a),e.__vertexHandleOfPrimitiveObjectUids.set(a.primitiveUid,o);return this.__dummyWhiteTextureUid=this.__webglResourceRepository.createDummyTexture(),this.__dummyBlackTextureUid=this.__webglResourceRepository.createDummyTexture("rgba(0, 0, 0, 1)"),this.__dummyBlackCubeTextureUid=this.__webglResourceRepository.createDummyCubeTexture(),n=I.a.getInstance().getModule("pbr").pbrCookTorranceBrdfLutDataUrl,s=this,[4,this.__webglResourceRepository.createTextureFromDataUri(n,{level:0,internalFormat:d.a.RGBA,border:0,format:d.a.RGBA,type:h.a.Float,magFilter:m.a.Nearest,minFilter:m.a.Nearest,wrapS:m.a.ClampToEdge,wrapT:m.a.ClampToEdge,generateMipmap:!1,anisotropy:!1})];case 1:return s.__pbrCookTorranceBrdfLutDataUrlUid=u.sent(),[2]}})})},e.prototype.$prerender=function(t,r){var i=[],a=t.getPrimitiveNumber();if(t.weights.length>0)for(var o=0;o<a;o++){var n=t.getPrimitiveAt(o);i[o]=e.__vertexHandleOfPrimitiveObjectUids.get(n.primitiveUid),this.__webglResourceRepository.resendVertexBuffer(n,i[o].vboHandles)}for(o=0;o<a;o++){n=t.getPrimitiveAt(o);i[o]=e.__vertexHandleOfPrimitiveObjectUids.get(n.primitiveUid),i[o].setComplete,this.__webglResourceRepository.setVertexDataToPipeline(i[o],n,r),i[o].setComplete=!0}},e.prototype.common_$prerender=function(){var e=G.a.getInstance();this.__lightComponents=e.getComponentsWithType(S.a)},e.prototype.attachGPUData=function(e){},e.prototype.attatchShaderProgram=function(e){},e.prototype.attachVertexData=function(t,r,i,a){var o=e.__vertexHandleOfPrimitiveObjectUids.get(r.primitiveUid),n=this.__webglResourceRepository.getWebGLResource(o.vaoHandle),s=i.getRawContext();if(null!=n)i.bindVertexArray(n);else{this.__webglResourceRepository.setVertexDataToPipeline(o,r,a);var u=this.__webglResourceRepository.getWebGLResource(o.iboHandle);s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,u)}},e.prototype.dettachVertexData=function(e){var t=e.getRawContext();e.bindVertexArray&&e.bindVertexArray(null),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),t.bindBuffer(t.ARRAY_BUFFER,null)},e.getInstance=function(){return this.__instance||(this.__instance=new e),this.__instance},e.prototype.common_$render=function(e,t,r){return!1},e.prototype.$render=function(t,r,i,a,o,n){var s=this.__webglResourceRepository.currentWebGLContextWrapper,u=s.getRawContext();t.componentSID===M.a.firstOpaqueSid&&(u.disable(u.BLEND),u.depthMask(!0)),t.componentSID==M.a.firstTranparentSid&&(u.enable(u.BLEND),u.blendFuncSeparate(u.SRC_ALPHA,u.ONE_MINUS_SRC_ALPHA,u.ONE,u.ONE),u.depthMask(!1));for(var _=t.getPrimitiveNumber(),p=0;p<_;p++){var d=t.getPrimitiveAt(p);this.attachVertexData(p,d,s,c.a.InvalidCGAPIResourceUid);var h=d.material,m=this.__webglResourceRepository.getWebGLResource(h._shaderProgramUid),f=h._shaderProgramUid,g=!1;f!==this.__lastShader&&(u.useProgram(m),this.__lastShader=f,g=!0);var R=e.__vertexHandleOfPrimitiveObjectUids.get(d.primitiveUid);this.__webglResourceRepository.setUniformValue(f,l.a.VertexAttributesExistenceArray,!1,1,"i",!0,{x:R.attributesFlags},{force:g}),P.a.transposeTo(r,e.transposedMatrix44),this.__webglResourceRepository.setUniformValue(f,l.a.WorldMatrix,!0,4,"f",!0,{x:e.transposedMatrix44.v},{force:g}),this.__webglResourceRepository.setUniformValue(f,l.a.NormalMatrix,!0,3,"f",!0,{x:i.v},{force:g});var b=G.a.getInstance().getComponent(L.a,L.a.main);if(b){this.__webglResourceRepository.setUniformValue(f,l.a.ViewMatrix,!0,4,"f",!0,{x:b.viewMatrix.v},{force:g}),this.__webglResourceRepository.setUniformValue(f,l.a.ProjectionMatrix,!0,4,"f",!0,{x:b.projectionMatrix.v},{force:g});var x=b.worldPosition;this.__webglResourceRepository.setUniformValue(f,l.a.ViewPosition,!1,3,"f",!0,{x:x.v},{force:g})}this.__webglResourceRepository.setUniformValue(f,l.a.LightNumber,!1,1,"i",!1,{x:this.__lightComponents.length},{force:g});for(var y=0;y<this.__lightComponents.length&&!(y>=A.a.maxLightNumberInShader);y++){var v=this.__lightComponents[y],w=v.entity.getSceneGraph().worldPosition,U=v.direction,S=v.intensity;this.__webglResourceRepository.setUniformValue(f,l.a.LightPosition,!1,4,"f",!1,{x:w.x,y:w.y,z:w.z,w:v.type.index},{force:g},y),this.__webglResourceRepository.setUniformValue(f,l.a.LightDirection,!1,4,"f",!1,{x:U.x,y:U.y,z:U.z,w:0},{force:g},y),this.__webglResourceRepository.setUniformValue(f,l.a.LightIntensity,!1,4,"f",!1,{x:S.x,y:S.y,z:S.z,w:0},{force:g},y)}var I=a.getComponent(T.a);if(I){var W=I.jointMatrices,B=I.jointCompressedChanks;this.__webglResourceRepository.setUniformValue(f,l.a.BoneMatrix,!0,4,"f",!0,{x:W},{force:g}),this.__webglResourceRepository.setUniformValue(f,l.a.BoneCompressedChank,!1,4,"f",!0,{x:B},{force:g}),this.__webglResourceRepository.setUniformValue(f,l.a.BoneCompressedInfo,!1,4,"f",!0,{x:I.jointCompressedInfo.v},{force:g}),this.__webglResourceRepository.setUniformValue(f,l.a.SkinningMode,!1,1,"i",!1,{x:!0},{force:g})}else this.__webglResourceRepository.setUniformValue(f,l.a.SkinningMode,!1,1,"i",!1,{x:!1},{force:g});if(this.__webglResourceRepository.setUniformValue(f,l.a.DiffuseEnvTexture,!1,1,"i",!1,{x:6},{force:g}))if(u.activeTexture(u.TEXTURE6),o&&o.isTextureReady){var V=this.__webglResourceRepository.getWebGLResource(o.cgApiResourceUid);u.bindTexture(u.TEXTURE_CUBE_MAP,V)}else{V=this.__webglResourceRepository.getWebGLResource(this.__dummyBlackCubeTextureUid);u.bindTexture(u.TEXTURE_CUBE_MAP,V)}if(this.__webglResourceRepository.setUniformValue(f,l.a.SpecularEnvTexture,!1,1,"i",!1,{x:7},{force:g}))if(u.activeTexture(u.TEXTURE7),n&&n.isTextureReady){V=this.__webglResourceRepository.getWebGLResource(n.cgApiResourceUid);u.bindTexture(u.TEXTURE_CUBE_MAP,V)}else{V=this.__webglResourceRepository.getWebGLResource(this.__dummyBlackCubeTextureUid);u.bindTexture(u.TEXTURE_CUBE_MAP,V)}var D=1;n&&(D=n.mipmapLevelNumber);var F=a.getComponent(M.a);if(this.__webglResourceRepository.setUniformValue(f,l.a.IBLParameter,!1,4,"f",!1,{x:D,y:F.diffuseCubeMapContribution,z:F.specularCubeMapContribution,w:F.rotationOfCubeMap},{force:g}),this.__webglResourceRepository.setUniformValue(f,l.a.BrdfLutTexture,!1,1,"i",!1,{x:5},{force:g}))if(u.activeTexture(u.TEXTURE5),null!=this.__pbrCookTorranceBrdfLutDataUrlUid){V=this.__webglResourceRepository.getWebGLResource(this.__pbrCookTorranceBrdfLutDataUrlUid);u.bindTexture(u.TEXTURE_2D,V)}else{V=this.__webglResourceRepository.getWebGLResource(this.__dummyWhiteTextureUid);u.bindTexture(u.TEXTURE_2D,V)}h&&h.setUniformValues(f,g);var E=new C.a(0,.1,.01);this.__webglResourceRepository.setUniformValue(f,l.a.PointSize,!1,1,"f",!1,{x:30},{force:g}),this.__webglResourceRepository.setUniformValue(f,l.a.PointDistanceAttenuation,!1,3,"f",!0,{x:E.v},{force:g}),d.indicesAccessor?u.drawElements(d.primitiveMode.index,d.indicesAccessor.elementCount,d.indicesAccessor.componentType.index,0):u.drawArrays(d.primitiveMode.index,0,d.getVertexCountAsVerticesBased()),this.dettachVertexData(s)}this.__lastShader=-1},e.__vertexHandleOfPrimitiveObjectUids=new Map,e.transposedMatrix44=new W.a([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),e}(),F=function(e){return e.index===i.a.UBOWebGL2.index?_.getInstance():e.index===i.a.TransformFeedbackWebGL2.index?w.getInstance():e.index===i.a.UniformWebGL1.index?D.getInstance():U.getInstance()},E=r(49),H=r(57),N=Object.freeze({getRenderingStrategy:F,GLSLShader:E.a,WebGLContextWrapper:H.a,WebGLResourceRepository:a.a,WebGLStrategyDataTexture:U,WebGLStrategyTransformFeedback:w,WebGLStrategyUBO:_,WebGLStrategyUniform:D});t.default=N}}]);