(window.webpackJsonp=window.webpackJsonp||[]).push([["webgl"],{72:function(e,t,i){"use strict";i.r(t);var r=i(48),a=i(55),o=i(24),n=i(29),s=i(22),u=i(9),c=i(4),_=i(5);class l{constructor(){this.__webglResourceRepository=a.a.getInstance(),this.__uboUid=c.a.InvalidCGAPIResourceUid,this.__vertexHandles=[],this.__isVAOSet=!1,this.vertexShaderMethodDefinitions_UBO="layout (std140) uniform matrix {\n    mat4 world[1024];\n  } u_matrix;\n\n  uniform mat4 u_viewMatrix;\n  uniform mat4 u_projectionMatrix;\n  uniform mat3 u_normalMatrix;\n\n  mat4 getMatrix(float instanceId) {\n    float index = instanceId;\n    return transpose(u_matrix.world[int(index)]);\n  }\n\n  mat4 getViewMatrix(float instanceId) {\n    return u_viewMatrix;\n  }\n\n  mat4 getProjectionMatrix(float instanceId) {\n    return u_projectionMatrix;\n  }\n\n  mat3 getNormalMatrix(float instanceId) {\n    return u_normalMatrix;\n  }\n\n  "}setupShaderProgram(e){const t=e.getPrimitiveNumber();for(let i=0;i<t;i++){const t=e.getPrimitiveAt(i).material;if(t){if(t._shaderProgramUid!==c.a.InvalidCGAPIResourceUid)return;t.createProgram(this.vertexShaderMethodDefinitions_UBO),this.__webglResourceRepository.setupUniformLocations(t._shaderProgramUid,[{semantic:_.a.ViewMatrix,isPlural:!1,isSystem:!0},{semantic:_.a.ProjectionMatrix,isPlural:!1,isSystem:!0}])}}}__isLoaded(e){return null!=this.__vertexHandles[e]}$load(e){if(this.__isLoaded(0))return;this.setupShaderProgram(e);const t=e.getPrimitiveNumber();for(let i=0;i<t;i++){const t=e.getPrimitiveAt(i),r=this.__webglResourceRepository.createVertexDataResources(t);this.__vertexHandles[i]=r,l.__vertexHandleOfPrimitiveObjectUids.set(t.objectUid,r)}}$prerender(e,t){if(this.__isVAOSet)return;const i=e.getPrimitiveNumber();for(let r=0;r<i;r++){const i=e.getPrimitiveAt(r);this.__vertexHandles[r]=l.__vertexHandleOfPrimitiveObjectUids.get(i.objectUid),this.__webglResourceRepository.setVertexDataToPipeline(this.__vertexHandles[r],i,t)}this.__isVAOSet=!0}common_$prerender(){const e=o.a.getInstance().getBuffer(u.a.GPUInstanceData);new Float32Array(e.getArrayBuffer());this.__uboUid===c.a.InvalidCGAPIResourceUid?(this.__uboUid=this.__webglResourceRepository.createUniformBuffer(s.a.getAccessor("worldMatrix",s.a).dataViewOfBufferView),this.__webglResourceRepository.bindUniformBufferBase(0,this.__uboUid)):this.__webglResourceRepository.updateUniformBuffer(this.__uboUid,s.a.getAccessor("worldMatrix",s.a).dataViewOfBufferView)}attachGPUData(e){this.__webglResourceRepository.bindUniformBlock(e.material._shaderProgramUid,"matrix",0)}attatchShaderProgram(e){const t=e._shaderProgramUid,i=this.__webglResourceRepository.currentWebGLContextWrapper.getRawContext(),r=this.__webglResourceRepository.getWebGLResource(t);i.useProgram(r)}attachVertexData(e,t,i,r){const a=this.__vertexHandles[e],o=this.__webglResourceRepository.getWebGLResource(a.vaoHandle),n=i.getRawContext();if(null!=o)i.bindVertexArray(o);else{this.__webglResourceRepository.setVertexDataToPipeline(a,t,r);const e=this.__webglResourceRepository.getWebGLResource(a.iboHandle);n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,e)}}static getInstance(){return this.__instance||(this.__instance=new l),this.__instance}common_$render(e,t,i){const r=this.__webglResourceRepository.currentWebGLContextWrapper,a=e.material;this.attatchShaderProgram(a);r.getRawContext();return this.__webglResourceRepository.setUniformValue(a._shaderProgramUid,_.a.ViewMatrix,!0,4,"f",!0,{x:t.v},{}),this.__webglResourceRepository.setUniformValue(a._shaderProgramUid,_.a.ProjectionMatrix,!0,4,"f",!0,{x:i.v},{}),!0}}l.__vertexHandleOfPrimitiveObjectUids=new Map;var d=i(37),m=i(33),h=i(2),p=i(16),g=i(41),f=i(21),R=i(35),x=i(1),b=i(3),y=i(17),w=i(61);class U{constructor(){this.__webglResourceRepository=a.a.getInstance(),this.__instanceDataTextureUid=c.a.InvalidCGAPIResourceUid,this.__vertexDataTextureUid=c.a.InvalidCGAPIResourceUid,this.__primitiveHeaderUboUid=c.a.InvalidCGAPIResourceUid,this.__indexCountToSubtractUboUid=c.a.InvalidCGAPIResourceUid,this.__entitiesUidUboUid=c.a.InvalidCGAPIResourceUid,this.__primitiveUidUboUid=c.a.InvalidCGAPIResourceUid,this.__isVertexReady=!1}get __transformFeedbackShaderText(){w.a.getInstance().glsl_vertex_in,w.a.getInstance().glsl_texture;return`\n    uniform mat4 u_worldMatrix;\n    uniform mat4 u_viewMatrix;\n    uniform mat4 u_projectionMatrix;\n    uniform mat3 u_normalMatrix;\n\n    mat4 getMatrix(float instanceId) {\n      return u_worldMatrix;\n    }\n\n    mat4 getViewMatrix(float instanceId) {\n      return u_viewMatrix;\n    }\n\n    mat4 getProjectionMatrix(float instanceId) {\n      return u_projectionMatrix;\n    }\n\n    mat3 getNormalMatrix(float instanceId) {\n      return u_normalMatrix;\n    }\n\n    layout (std140) uniform indexCountsToSubtract {\n      ivec4 counts[256];\n    } u_indexCountsToSubtract;\n    layout (std140) uniform entityUids {\n      ivec4 ids[256];\n    } u_entityData;\n    layout (std140) uniform primitiveUids {\n      ivec4 ids[256];\n    } u_primitiveData;\n    layout (std140) uniform primitiveHeader {\n      ivec4 data[256];\n    } u_primitiveHeader;\n\n    out vec4 position;\n    //out vec3 colors;\n\n    uniform sampler2D u_instanceDataTexture;\n    uniform sampler2D u_vertexDataTexture;\n\n    // void main(){\n    //   int indexOfVertices = gl_VertexID + 3*gl_InstanceID;\n\n    //   int entityUidMinusOne = 0;\n    //   int primitiveUid = 0;\n    //   for (int i=0; i<=indexOfVertices; i++) {\n    //     for (int j=0; j<1024; j++) {\n    //       int value = u_indexCountsToSubtract.counts[j/4][j%4];\n    //       int result = int(step(float(value), float(i)));\n    //       if (result > 0) {\n    //         entityUidMinusOne = result * int(u_entityData.ids[j/4][j%4]) - 1;\n    //         primitiveUid = result * u_primitiveData.ids[j/4][j%4];\n    //       } else {\n    //         break;\n    //       }\n    //     }\n    //   }\n\n    //   ivec4 indicesMeta = u_primitiveHeader.data[9*primitiveUid + 0];\n    //   int primIndicesByteOffset = indicesMeta.x;\n    //   int primIndicesComponentSizeInByte = indicesMeta.y;\n    //   int primIndicesLength = indicesMeta.z;\n\n    //   int idx = gl_VertexID - primIndicesByteOffset / 4 /*byte*/;\n\n    //   // get Indices\n    //   int texelLength = ${o.a.bufferWidthLength};\n    //   vec4 indexVec4 = texelFetch(u_vertexDataTexture, ivec2(idx%texelLength, idx/texelLength), 0);\n    //   int index = int(indexVec4[idx%4]);\n\n    //   // get Positions\n    //   ivec4 indicesData = u_primitiveHeader.data[9*primitiveUid + 1];\n    //   int primPositionsByteOffset = indicesData.x;\n    //   idx = primPositionsByteOffset/4 + index;\n    //   vec4 posVec4 = texelFetch(u_vertexDataTexture, ivec2(idx%texelLength, idx/texelLength), 0);\n\n    //   position = posVec4;\n    //}\n`}get __transformFeedbackFragmentShaderText(){return"#version 300 es\nprecision highp float;\n\nout vec4 outColor;\n\nvoid main(){\n    outColor = vec4(1.0);\n}\n    "}setupShaderProgram(e){const t=e.getPrimitiveNumber();for(let i=0;i<t;i++){const t=e.getPrimitiveAt(i).material;if(t){if(t._shaderProgramUid!==c.a.InvalidCGAPIResourceUid)return;t.createProgram(this.__transformFeedbackShaderText),this.__webglResourceRepository.setupUniformLocations(t._shaderProgramUid,[{semantic:_.a.ViewMatrix,isPlural:!1,isSystem:!0},{semantic:_.a.ProjectionMatrix,isPlural:!1,isSystem:!0}])}}}$load(e){if(this.__isVertexReady)return;this.setupShaderProgram(e);const t=o.a.getInstance().getBuffer(u.a.CPUGeneric),i=t.takeBufferView({byteLengthToNeed:12,byteStride:4,isAoS:!1}).takeAccessor({compositionType:x.a.Scalar,componentType:h.a.UnsingedInt,count:3}),r=t.takeBufferView({byteLengthToNeed:48,byteStride:16,isAoS:!1}).takeAccessor({compositionType:x.a.Vec4,componentType:h.a.Float,count:3}),a=i.getTypedArray();a[0]=0,a[1]=1,a[2]=2;const n=R.a.createPrimitive({indices:a,attributeCompositionTypes:[r.compositionType],attributeSemantics:[b.a.Position],attributes:[r.getTypedArray()],primitiveMode:y.a.Triangles,material:void 0});this.__vertexHandle=this.__webglResourceRepository.createVertexDataResources(n),this.__isVertexReady=!0}$prerender(e,t){}__setupUBOPrimitiveHeaderData(){const e=o.a.getInstance().getBuffer(u.a.UBOGeneric),t=new Int32Array(e.getArrayBuffer());this.__primitiveHeaderUboUid===c.a.InvalidCGAPIResourceUid&&(this.__primitiveHeaderUboUid=this.__webglResourceRepository.createUniformBuffer(t),this.__webglResourceRepository.bindUniformBufferBase(3,this.__primitiveHeaderUboUid))}__setupGPUInstanceMetaData(){if(this.__primitiveUidUboUid!==c.a.InvalidCGAPIResourceUid)return;const e=g.a.getInstance()._getEntities(),t=new Int32Array(e.length),i=new Int32Array(e.length),r=new Int32Array(e.length);let a=0;e.forEach((e,o)=>{const n=e.getComponent(f.a);if(n){i[o]=n.getPrimitiveAt(0).primitiveUid,t[o]=e.entityUID;const s=n.getPrimitiveAt(0).indicesAccessor.elementCount;r[o]=a+s,a+=s}}),this.__indexCountToSubtractUboUid=this.__webglResourceRepository.createUniformBuffer(r),this.__webglResourceRepository.bindUniformBufferBase(0,this.__indexCountToSubtractUboUid),this.__entitiesUidUboUid=this.__webglResourceRepository.createUniformBuffer(t),this.__webglResourceRepository.bindUniformBufferBase(1,this.__entitiesUidUboUid),this.__primitiveUidUboUid=this.__webglResourceRepository.createUniformBuffer(i),this.__webglResourceRepository.bindUniformBufferBase(2,this.__primitiveUidUboUid)}__setupGPUInstanceData(){let e=!1;(this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2||this.__webglResourceRepository.currentWebGLContextWrapper.isSupportWebGL1Extension(d.a.TextureHalfFloat))&&(e=!0);const t=o.a.getInstance().getBuffer(u.a.GPUInstanceData),i=new Float32Array(t.getArrayBuffer());let r;if(e){r=new Uint16Array(i.length);let e=t.takenSizeInByte/4;e/=2;for(let t=0;t<e;t++)r[t]=n.a.toHalfFloat(i[t])}this.__instanceDataTextureUid===c.a.InvalidCGAPIResourceUid?e?this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2?this.__instanceDataTextureUid=this.__webglResourceRepository.createTexture(i,{level:0,internalFormat:p.a.RGBA16F,width:o.a.bufferWidthLength,height:o.a.bufferHeightLength,border:0,format:m.a.RGBA,type:h.a.Float,magFilter:p.a.Nearest,minFilter:p.a.Nearest,wrapS:p.a.Repeat,wrapT:p.a.Repeat,generateMipmap:!1,anisotropy:!1}):this.__instanceDataTextureUid=this.__webglResourceRepository.createTexture(r,{level:0,internalFormat:m.a.RGBA,width:o.a.bufferWidthLength,height:o.a.bufferHeightLength,border:0,format:m.a.RGBA,type:h.a.HalfFloat,magFilter:p.a.Nearest,minFilter:p.a.Nearest,wrapS:p.a.Repeat,wrapT:p.a.Repeat,generateMipmap:!1,anisotropy:!1}):this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2?this.__instanceDataTextureUid=this.__webglResourceRepository.createTexture(i,{level:0,internalFormat:p.a.RGBA32F,width:o.a.bufferWidthLength,height:o.a.bufferHeightLength,border:0,format:m.a.RGBA,type:h.a.Float,magFilter:p.a.Nearest,minFilter:p.a.Nearest,wrapS:p.a.Repeat,wrapT:p.a.Repeat,generateMipmap:!1,anisotropy:!1}):this.__instanceDataTextureUid=this.__webglResourceRepository.createTexture(i,{level:0,internalFormat:m.a.RGBA,width:o.a.bufferWidthLength,height:o.a.bufferHeightLength,border:0,format:m.a.RGBA,type:h.a.Float,magFilter:p.a.Nearest,minFilter:p.a.Nearest,wrapS:p.a.Repeat,wrapT:p.a.Repeat,generateMipmap:!1,anisotropy:!1}):e?this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2?this.__webglResourceRepository.updateTexture(this.__instanceDataTextureUid,i,{level:0,width:o.a.bufferWidthLength,height:o.a.bufferHeightLength,format:m.a.RGBA,type:h.a.Float}):this.__webglResourceRepository.updateTexture(this.__instanceDataTextureUid,r,{level:0,width:o.a.bufferWidthLength,height:o.a.bufferHeightLength,format:m.a.RGBA,type:h.a.HalfFloat}):(this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2,this.__webglResourceRepository.updateTexture(this.__instanceDataTextureUid,i,{level:0,width:o.a.bufferWidthLength,height:o.a.bufferHeightLength,format:m.a.RGBA,type:h.a.Float}))}__setupGPUVertexData(){if(this.__vertexDataTextureUid!==c.a.InvalidCGAPIResourceUid)return;const e=o.a.getInstance().getBuffer(u.a.GPUVertexData),t=new Float32Array(e.getArrayBuffer());this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2?this.__vertexDataTextureUid=this.__webglResourceRepository.createTexture(t,{level:0,internalFormat:p.a.RGBA32F,width:o.a.bufferWidthLength,height:o.a.bufferHeightLength,border:0,format:m.a.RGBA,type:h.a.Float,magFilter:p.a.Nearest,minFilter:p.a.Nearest,wrapS:p.a.Repeat,wrapT:p.a.Repeat,generateMipmap:!1,anisotropy:!1}):this.__vertexDataTextureUid=this.__webglResourceRepository.createTexture(t,{level:0,internalFormat:m.a.RGBA,width:o.a.bufferWidthLength,height:o.a.bufferHeightLength,border:0,format:m.a.RGBA,type:h.a.Float,magFilter:p.a.Nearest,minFilter:p.a.Nearest,wrapS:p.a.Repeat,wrapT:p.a.Repeat,generateMipmap:!1,anisotropy:!1})}common_$prerender(){this.__setupUBOPrimitiveHeaderData(),this.__setupGPUInstanceMetaData(),this.__setupGPUInstanceData(),this.__setupGPUVertexData()}attachGPUData(e){const t=e.material;{const e=this.__webglResourceRepository.currentWebGLContextWrapper.getRawContext(),r=this.__webglResourceRepository.getWebGLResource(this.__instanceDataTextureUid);e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,r);const a=this.__webglResourceRepository.getWebGLResource(t._shaderProgramUid);var i=e.getUniformLocation(a,"u_instanceDataTexture");e.uniform1i(i,0)}{const e=this.__webglResourceRepository.currentWebGLContextWrapper.getRawContext(),i=this.__webglResourceRepository.getWebGLResource(this.__vertexDataTextureUid);e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,i);const a=this.__webglResourceRepository.getWebGLResource(t._shaderProgramUid);var r=e.getUniformLocation(a,"u_vertexDataTexture");e.uniform1i(r,1)}this.__webglResourceRepository.bindUniformBlock(t._shaderProgramUid,"indexCountsToSubtract",0),this.__webglResourceRepository.bindUniformBlock(t._shaderProgramUid,"entityUids",1),this.__webglResourceRepository.bindUniformBlock(t._shaderProgramUid,"primitiveUids",2),this.__webglResourceRepository.bindUniformBlock(t._shaderProgramUid,"primitiveHeader",3)}attatchShaderProgram(e){const t=e._shaderProgramUid,i=this.__webglResourceRepository.currentWebGLContextWrapper.getRawContext(),r=this.__webglResourceRepository.getWebGLResource(t);i.useProgram(r)}attachVertexData(e,t,i,r){}static getInstance(){return this.__instance||(this.__instance=new U),this.__instance}common_$render(e,t,i){const r=e.material,a=this.__webglResourceRepository.currentWebGLContextWrapper;this.attatchShaderProgram(e.material);a.getRawContext();return this.__webglResourceRepository.setUniformValue(r._shaderProgramUid,_.a.ViewMatrix,!0,4,"f",!0,{x:t.v},{}),this.__webglResourceRepository.setUniformValue(r._shaderProgramUid,_.a.ProjectionMatrix,!0,4,"f",!0,{x:i.v},{}),!0}}class v{constructor(){this.__webglResourceRepository=a.a.getInstance(),this.__dataTextureUid=c.a.InvalidCGAPIResourceUid,this.__vertexHandles=[],this.__isVAOSet=!1}get vertexShaderMethodDefinitions_dataTexture(){const e=w.a.getInstance().glsl_texture;return`\n  uniform sampler2D u_dataTexture;\n  uniform mat4 u_viewMatrix;\n  uniform mat4 u_projectionMatrix;\n  uniform mat3 u_normalMatrix;\n\n  /*\n   * This idea from https://qiita.com/YVT/items/c695ab4b3cf7faa93885\n   * arg = vec2(1. / size.x, 1. / size.x / size.y);\n   */\n  // vec4 fetchElement(sampler2D tex, float index, vec2 arg)\n  // {\n  //   return ${e}( tex, arg * (index + 0.5) );\n  // }\n\n  vec4 fetchElement(sampler2D tex, float index, vec2 invSize)\n  {\n    float t = (index + 0.5) * invSize.x;\n    float x = fract(t);\n    float y = (floor(t) + 0.5) * invSize.y;\n    return ${e}( tex, vec2(x, y) );\n  }\n\n  mat4 getMatrix(float instanceId)\n  {\n    float index = instanceId;\n    float powWidthVal = ${o.a.bufferWidthLength}.0;\n    float powHeightVal = ${o.a.bufferHeightLength}.0;\n    vec2 arg = vec2(1.0/powWidthVal, 1.0/powHeightVal);\n  //  vec2 arg = vec2(1.0/powWidthVal, 1.0/powWidthVal/powHeightVal);\n\n    vec4 col0 = fetchElement(u_dataTexture, index * 4.0 + 0.0, arg);\n   vec4 col1 = fetchElement(u_dataTexture, index * 4.0 + 1.0, arg);\n   vec4 col2 = fetchElement(u_dataTexture, index * 4.0 + 2.0, arg);\n\n    mat4 matrix = mat4(\n      col0.x, col1.x, col2.x, 0.0,\n      col0.y, col1.y, col2.y, 0.0,\n      col0.z, col1.z, col2.z, 0.0,\n      col0.w, col1.w, col2.w, 1.0\n      );\n\n    return matrix;\n  }\n\n  mat4 getViewMatrix(float instanceId) {\n    return u_viewMatrix;\n  }\n\n  mat4 getProjectionMatrix(float instanceId) {\n    return u_projectionMatrix;\n  }\n\n  mat3 getNormalMatrix(float instanceId) {\n    return u_normalMatrix;\n  }\n\n  `}setupShaderProgram(e){const t=e.getPrimitiveNumber();for(let i=0;i<t;i++){const t=e.getPrimitiveAt(i).material;if(t){if(t._shaderProgramUid!==c.a.InvalidCGAPIResourceUid)return;t.createProgram(this.vertexShaderMethodDefinitions_dataTexture),this.__webglResourceRepository.setupUniformLocations(t._shaderProgramUid,[{semantic:_.a.ViewMatrix,isPlural:!1,isSystem:!0},{semantic:_.a.ProjectionMatrix,isPlural:!1,isSystem:!0}])}}}__isLoaded(e){return null!=this.__vertexHandles[e]}$load(e){if(this.__isLoaded(0))return;this.__meshComponent=e,this.setupShaderProgram(e);const t=e.getPrimitiveNumber();for(let i=0;i<t;i++){const t=e.getPrimitiveAt(i),r=this.__webglResourceRepository.createVertexDataResources(t);this.__vertexHandles[i]=r,v.__vertexHandleOfPrimitiveObjectUids.set(t.objectUid,r)}}$prerender(e,t){if(this.__isVAOSet)return;const i=e.getPrimitiveNumber();for(let r=0;r<i;r++){const i=e.getPrimitiveAt(r);this.__vertexHandles[r]=v.__vertexHandleOfPrimitiveObjectUids.get(i.objectUid),this.__webglResourceRepository.setVertexDataToPipeline(this.__vertexHandles[r],i,t)}this.__isVAOSet=!0}common_$prerender(){let e=!1;(this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2||this.__webglResourceRepository.currentWebGLContextWrapper.isSupportWebGL1Extension(d.a.TextureHalfFloat))&&(e=!0);const t=o.a.getInstance().getBuffer(u.a.GPUInstanceData),i=new Float32Array(t.getArrayBuffer());let r;if(e){r=new Uint16Array(i.length);let e=t.takenSizeInByte/4;e/=2;for(let t=0;t<e;t++)r[t]=n.a.toHalfFloat(i[t])}this.__dataTextureUid===c.a.InvalidCGAPIResourceUid?e?this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2?this.__dataTextureUid=this.__webglResourceRepository.createTexture(i,{level:0,internalFormat:p.a.RGBA16F,width:o.a.bufferWidthLength,height:o.a.bufferHeightLength,border:0,format:m.a.RGBA,type:h.a.Float,magFilter:p.a.Nearest,minFilter:p.a.Nearest,wrapS:p.a.Repeat,wrapT:p.a.Repeat,generateMipmap:!1,anisotropy:!1}):this.__dataTextureUid=this.__webglResourceRepository.createTexture(r,{level:0,internalFormat:m.a.RGBA,width:o.a.bufferWidthLength,height:o.a.bufferHeightLength,border:0,format:m.a.RGBA,type:h.a.HalfFloat,magFilter:p.a.Nearest,minFilter:p.a.Nearest,wrapS:p.a.Repeat,wrapT:p.a.Repeat,generateMipmap:!1,anisotropy:!1}):this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2?this.__dataTextureUid=this.__webglResourceRepository.createTexture(i,{level:0,internalFormat:p.a.RGBA32F,width:o.a.bufferWidthLength,height:o.a.bufferHeightLength,border:0,format:m.a.RGBA,type:h.a.Float,magFilter:p.a.Nearest,minFilter:p.a.Nearest,wrapS:p.a.Repeat,wrapT:p.a.Repeat,generateMipmap:!1,anisotropy:!1}):this.__dataTextureUid=this.__webglResourceRepository.createTexture(i,{level:0,internalFormat:m.a.RGBA,width:o.a.bufferWidthLength,height:o.a.bufferHeightLength,border:0,format:m.a.RGBA,type:h.a.Float,magFilter:p.a.Nearest,minFilter:p.a.Nearest,wrapS:p.a.Repeat,wrapT:p.a.Repeat,generateMipmap:!1,anisotropy:!1}):e?this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2?this.__webglResourceRepository.updateTexture(this.__dataTextureUid,i,{level:0,width:o.a.bufferWidthLength,height:t.takenSizeInByte/o.a.bufferWidthLength/4,format:m.a.RGBA,type:h.a.Float}):this.__webglResourceRepository.updateTexture(this.__dataTextureUid,r,{level:0,width:o.a.bufferWidthLength,height:t.takenSizeInByte/o.a.bufferWidthLength/4,format:m.a.RGBA,type:h.a.HalfFloat}):(this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2,this.__webglResourceRepository.updateTexture(this.__dataTextureUid,i,{level:0,width:o.a.bufferWidthLength,height:t.takenSizeInByte/o.a.bufferWidthLength/4,format:m.a.RGBA,type:h.a.Float}))}attachGPUData(e){const t=e.material,i=this.__webglResourceRepository.currentWebGLContextWrapper.getRawContext(),r=this.__webglResourceRepository.getWebGLResource(this.__dataTextureUid);i.bindTexture(i.TEXTURE_2D,r);const a=this.__webglResourceRepository.getWebGLResource(t._shaderProgramUid);var o=i.getUniformLocation(a,"u_dataTexture");i.uniform1i(o,0)}attatchShaderProgram(e){const t=e._shaderProgramUid,i=this.__webglResourceRepository.currentWebGLContextWrapper.getRawContext(),r=this.__webglResourceRepository.getWebGLResource(t);i.useProgram(r)}attachVertexData(e,t,i,r){const a=this.__vertexHandles[e],o=this.__webglResourceRepository.getWebGLResource(a.vaoHandle),n=i.getRawContext();if(null!=o)i.bindVertexArray(o);else{this.__webglResourceRepository.setVertexDataToPipeline(a,t,r);const e=this.__webglResourceRepository.getWebGLResource(a.iboHandle);n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,e)}}static getInstance(){return this.__instance||(this.__instance=new v),this.__instance}common_$render(e,t,i){const r=e.material,a=this.__webglResourceRepository.currentWebGLContextWrapper;this.attatchShaderProgram(r);a.getRawContext();return this.__webglResourceRepository.setUniformValue(r._shaderProgramUid,_.a.ViewMatrix,!0,4,"f",!0,{x:t.v},{}),this.__webglResourceRepository.setUniformValue(r._shaderProgramUid,_.a.ProjectionMatrix,!0,4,"f",!0,{x:i.v},{}),!0}}v.__vertexHandleOfPrimitiveObjectUids=new Map;var T=i(42),P=i(60),L=i(12),M=i(63),G=i(27),I=i(45),A=i(52),S=i(50),W=i(0),C=i(44),B=function(e,t,i,r){return new(i||(i=Promise))(function(a,o){function n(e){try{u(r.next(e))}catch(e){o(e)}}function s(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){e.done?a(e.value):new i(function(t){t(e.value)}).then(n,s)}u((r=r.apply(e,t||[])).next())})};class V{constructor(){this.__webglResourceRepository=a.a.getInstance(),this.vertexShaderMethodDefinitions_uniform="\n  uniform mat4 u_worldMatrix;\n  uniform mat4 u_viewMatrix;\n  uniform mat4 u_projectionMatrix;\n  uniform mat3 u_normalMatrix;\n\n  mat4 getMatrix(float instanceId) {\n    return u_worldMatrix;\n  }\n\n  mat4 getViewMatrix(float instanceId) {\n    return u_viewMatrix;\n  }\n\n  mat4 getProjectionMatrix(float instanceId) {\n    return u_projectionMatrix;\n  }\n\n  mat3 getNormalMatrix(float instanceId) {\n    return u_normalMatrix;\n  }\n  ",this.__lastShader=-1}setupShaderProgram(e){const t=e.getPrimitiveNumber();for(let i=0;i<t;i++){const t=e.getPrimitiveAt(i),r=t.material;if(r){if(r._shaderProgramUid!==c.a.InvalidCGAPIResourceUid)return;const e=this.__webglResourceRepository.currentWebGLContextWrapper.getRawContext();r.createProgram(this.vertexShaderMethodDefinitions_uniform);const i=[{semantic:_.a.WorldMatrix,isPlural:!1,isSystem:!0},{semantic:_.a.ViewMatrix,isPlural:!1,isSystem:!0},{semantic:_.a.ProjectionMatrix,isPlural:!1,isSystem:!0},{semantic:_.a.NormalMatrix,isPlural:!1,isSystem:!0},{semantic:_.a.BoneMatrix,isPlural:!0,isSystem:!0},{semantic:_.a.BoneCompressedChank,isPlural:!0,isSystem:!0},{semantic:_.a.BoneCompressedInfo,isPlural:!1,isSystem:!0},{semantic:_.a.LightNumber,isPlural:!1,isSystem:!0},{semantic:_.a.ViewPosition,isPlural:!1,isSystem:!0},{semantic:_.a.SkinningMode,compositionType:x.a.Scalar,componentType:h.a.Int,isPlural:!1,isSystem:!0},{semantic:_.a.DiffuseEnvTexture,compositionType:x.a.TextureCube,componentType:h.a.Int,isPlural:!1,isSystem:!0},{semantic:_.a.SpecularEnvTexture,compositionType:x.a.TextureCube,componentType:h.a.Int,isPlural:!1,isSystem:!0},{semantic:_.a.IBLParameter,compositionType:x.a.Vec4,componentType:h.a.Float,isPlural:!1,isSystem:!0},{semantic:_.a.BrdfLutTexture,compositionType:x.a.Texture2D,componentType:h.a.Int,isPlural:!1,isSystem:!0},{semantic:_.a.VertexAttributesExistenceArray,compositionType:x.a.Scalar,componentType:h.a.Int,isPlural:!1,isSystem:!0},{semantic:_.a.HDRIFormat,compositionType:x.a.Vec2,componentType:h.a.Int,isPlural:!1,isSystem:!0}];t.primitiveMode.index===e.POINTS&&i.push({semantic:_.a.PointSize,compositionType:x.a.Scalar,componentType:h.a.Float,isPlural:!1,isSystem:!0},{semantic:_.a.PointDistanceAttenuation,compositionType:x.a.Vec3,componentType:h.a.Float,isPlural:!1,isSystem:!0});const a=[];for(let e=0;e<G.a.maxLightNumberInShader;e++)a.push({semantic:_.a.LightPosition,isPlural:!1,prefix:`lights[${e}].`,index:e,isSystem:!0}),a.push({semantic:_.a.LightDirection,isPlural:!1,prefix:`lights[${e}].`,index:e,isSystem:!0}),a.push({semantic:_.a.LightIntensity,isPlural:!1,prefix:`lights[${e}].`,index:e,isSystem:!0});this.__webglResourceRepository.setupUniformLocations(r._shaderProgramUid,i.concat(a)),r.setUniformLocations(r._shaderProgramUid)}}}$load(e){return B(this,void 0,void 0,function*(){this.setupShaderProgram(e);const t=e.getPrimitiveNumber();for(let i=0;i<t;i++){const t=e.getPrimitiveAt(i),r=this.__webglResourceRepository.createVertexDataResources(t);V.__vertexHandleOfPrimitiveObjectUids.set(t.primitiveUid,r)}this.__dummyWhiteTextureUid=this.__webglResourceRepository.createDummyTexture(),this.__dummyBlackTextureUid=this.__webglResourceRepository.createDummyTexture("rgba(0, 0, 0, 1)"),this.__dummyBlackCubeTextureUid=this.__webglResourceRepository.createDummyCubeTexture();const i=I.a.getInstance().getModule("pbr").pbrCookTorranceBrdfLutDataUrl;this.__pbrCookTorranceBrdfLutDataUrlUid=yield this.__webglResourceRepository.createTextureFromDataUri(i,{level:0,internalFormat:m.a.RGBA,border:0,format:m.a.RGBA,type:h.a.Float,magFilter:p.a.Linear,minFilter:p.a.Linear,wrapS:p.a.ClampToEdge,wrapT:p.a.ClampToEdge,generateMipmap:!1,anisotropy:!1})})}$prerender(e,t){const i=[],r=e.getPrimitiveNumber();if(e.weights.length>0)for(let t=0;t<r;t++){const r=e.getPrimitiveAt(t);i[t]=V.__vertexHandleOfPrimitiveObjectUids.get(r.primitiveUid),this.__webglResourceRepository.resendVertexBuffer(r,i[t].vboHandles)}for(let a=0;a<r;a++){const r=e.getPrimitiveAt(a);i[a]=V.__vertexHandleOfPrimitiveObjectUids.get(r.primitiveUid),i[a].setComplete,this.__webglResourceRepository.setVertexDataToPipeline(i[a],r,t),i[a].setComplete=!0}}common_$prerender(){const e=L.a.getInstance();this.__lightComponents=e.getComponentsWithType(M.a)}attachGPUData(e){}attatchShaderProgram(e){}attachVertexData(e,t,i,r){const a=V.__vertexHandleOfPrimitiveObjectUids.get(t.primitiveUid),o=this.__webglResourceRepository.getWebGLResource(a.vaoHandle),n=i.getRawContext();if(null!=o)i.bindVertexArray(o);else{this.__webglResourceRepository.setVertexDataToPipeline(a,t,r);const e=this.__webglResourceRepository.getWebGLResource(a.iboHandle);n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,e)}}dettachVertexData(e){const t=e.getRawContext();e.bindVertexArray&&e.bindVertexArray(null),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),t.bindBuffer(t.ARRAY_BUFFER,null)}static getInstance(){return this.__instance||(this.__instance=new V),this.__instance}common_$render(e,t,i){return!1}static isOpaqueMode(){return V.__isOpaqueMode}static isTransparentMode(){return!V.__isOpaqueMode}$render(e,t,i,r,a,o,n,s){const u=this.__webglResourceRepository.currentWebGLContextWrapper,l=u.getRawContext();0===e&&(l.disable(l.BLEND),l.enable(l.DEPTH_TEST),l.depthMask(!0),V.__isOpaqueMode=!0),e===A.a.firstTranparentIndex&&(l.enable(l.BLEND),l.blendFuncSeparate(l.SRC_ALPHA,l.ONE_MINUS_SRC_ALPHA,l.ONE,l.ONE),l.depthMask(!1),V.__isOpaqueMode=!1);const d=t.getPrimitiveNumber();for(let e=0;e<d;e++){const d=t.getPrimitiveAt(e);if(V.isOpaqueMode()&&d.isBlend())continue;if(V.isTransparentMode()&&d.isOpaque())continue;this.attachVertexData(e,d,u,c.a.InvalidCGAPIResourceUid);const m=d.material,h=this.__webglResourceRepository.getWebGLResource(m._shaderProgramUid),p=m._shaderProgramUid;let g=!1;p!==this.__lastShader&&(l.useProgram(h),this.__lastShader=p,g=!0);const f=V.__vertexHandleOfPrimitiveObjectUids.get(d.primitiveUid);this.__webglResourceRepository.setUniformValue(p,_.a.VertexAttributesExistenceArray,!1,1,"i",!0,{x:f.attributesFlags},{force:g}),T.a.transposeTo(i,V.transposedMatrix44),this.__webglResourceRepository.setUniformValue(p,_.a.WorldMatrix,!0,4,"f",!0,{x:V.transposedMatrix44.v},{force:g}),this.__webglResourceRepository.setUniformValue(p,_.a.NormalMatrix,!0,3,"f",!0,{x:r.v},{force:g});const R=o.cameraComponent;if(R){this.__webglResourceRepository.setUniformValue(p,_.a.ViewMatrix,!0,4,"f",!0,{x:R.viewMatrix.v},{force:g}),this.__webglResourceRepository.setUniformValue(p,_.a.ProjectionMatrix,!0,4,"f",!0,{x:R.projectionMatrix.v},{force:g});const e=R.worldPosition;this.__webglResourceRepository.setUniformValue(p,_.a.ViewPosition,!1,3,"f",!0,{x:e.v},{force:g})}this.__webglResourceRepository.setUniformValue(p,_.a.LightNumber,!1,1,"i",!1,{x:this.__lightComponents.length},{force:g});for(let e=0;e<this.__lightComponents.length&&!(e>=G.a.maxLightNumberInShader);e++){const t=this.__lightComponents[e],i=t.entity.getSceneGraph().worldPosition,r=t.direction,a=t.intensity;this.__webglResourceRepository.setUniformValue(p,_.a.LightPosition,!1,4,"f",!1,{x:i.x,y:i.y,z:i.z,w:t.type.index},{force:g},e),this.__webglResourceRepository.setUniformValue(p,_.a.LightDirection,!1,4,"f",!1,{x:r.x,y:r.y,z:r.z,w:0},{force:g},e),this.__webglResourceRepository.setUniformValue(p,_.a.LightIntensity,!1,4,"f",!1,{x:a.x,y:a.y,z:a.z,w:0},{force:g},e)}const x=a.getComponent(P.a);if(x){const e=x.jointMatrices,t=x.jointCompressedChanks;this.__webglResourceRepository.setUniformValue(p,_.a.BoneMatrix,!0,4,"f",!0,{x:e},{force:g}),this.__webglResourceRepository.setUniformValue(p,_.a.BoneCompressedChank,!1,4,"f",!0,{x:t},{force:g}),this.__webglResourceRepository.setUniformValue(p,_.a.BoneCompressedInfo,!1,4,"f",!0,{x:x.jointCompressedInfo.v},{force:g}),this.__webglResourceRepository.setUniformValue(p,_.a.SkinningMode,!1,1,"i",!1,{x:!0},{force:g})}else this.__webglResourceRepository.setUniformValue(p,_.a.SkinningMode,!1,1,"i",!1,{x:!1},{force:g});let b;if(b=this.__webglResourceRepository.setUniformValue(p,_.a.DiffuseEnvTexture,!1,1,"i",!1,{x:6},{force:g}))if(l.activeTexture(l.TEXTURE6),n&&n.isTextureReady){const e=this.__webglResourceRepository.getWebGLResource(n.cgApiResourceUid);l.bindTexture(l.TEXTURE_CUBE_MAP,e)}else{const e=this.__webglResourceRepository.getWebGLResource(this.__dummyBlackCubeTextureUid);l.bindTexture(l.TEXTURE_CUBE_MAP,e)}if(b=this.__webglResourceRepository.setUniformValue(p,_.a.SpecularEnvTexture,!1,1,"i",!1,{x:7},{force:g}))if(l.activeTexture(l.TEXTURE7),s&&s.isTextureReady){const e=this.__webglResourceRepository.getWebGLResource(s.cgApiResourceUid);l.bindTexture(l.TEXTURE_CUBE_MAP,e)}else{const e=this.__webglResourceRepository.getWebGLResource(this.__dummyBlackCubeTextureUid);l.bindTexture(l.TEXTURE_CUBE_MAP,e)}let y=1;s&&(y=s.mipmapLevelNumber);const w=a.getComponent(A.a);this.__webglResourceRepository.setUniformValue(p,_.a.IBLParameter,!1,4,"f",!1,{x:y,y:w.diffuseCubeMapContribution,z:w.specularCubeMapContribution,w:w.rotationOfCubeMap},{force:g});let U=C.a.LDR_SRGB.index,v=C.a.LDR_SRGB.index;if(w.diffuseCubeMap&&(U=w.diffuseCubeMap.hdriFormat.index),w.specularCubeMap&&(v=w.specularCubeMap.hdriFormat.index),this.__webglResourceRepository.setUniformValue(p,_.a.HDRIFormat,!1,2,"i",!1,{x:U,y:v},{force:g}),b=this.__webglResourceRepository.setUniformValue(p,_.a.BrdfLutTexture,!1,1,"i",!1,{x:5},{force:g}))if(l.activeTexture(l.TEXTURE5),null!=this.__pbrCookTorranceBrdfLutDataUrlUid){const e=this.__webglResourceRepository.getWebGLResource(this.__pbrCookTorranceBrdfLutDataUrlUid);l.bindTexture(l.TEXTURE_2D,e)}else{const e=this.__webglResourceRepository.getWebGLResource(this.__dummyWhiteTextureUid);l.bindTexture(l.TEXTURE_2D,e)}const L=new W.b(0,.1,.01);this.__webglResourceRepository.setUniformValue(p,_.a.PointSize,!1,1,"f",!1,{x:30},{force:g}),this.__webglResourceRepository.setUniformValue(p,_.a.PointDistanceAttenuation,!1,3,"f",!0,{x:L.v},{force:g}),m&&m.setUniformValues(p,g),d.indicesAccessor?l.drawElements(d.primitiveMode.index,d.indicesAccessor.elementCount,d.indicesAccessor.componentType.index,0):l.drawArrays(d.primitiveMode.index,0,d.getVertexCountAsVerticesBased()),this.dettachVertexData(u)}this.__lastShader=-1}}V.__vertexHandleOfPrimitiveObjectUids=new Map,V.__isOpaqueMode=!0,V.transposedMatrix44=new S.a([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]);var D=function(e){return e.index===r.a.UBOWebGL2.index?l.getInstance():e.index===r.a.TransformFeedbackWebGL2.index?U.getInstance():e.index===r.a.UniformWebGL1.index||e.index===r.a.UniformWebGL2.index?V.getInstance():v.getInstance()},F=i(36),E=i(62);const H=Object.freeze({getRenderingStrategy:D,GLSLShader:F.a,WebGLContextWrapper:E.a,WebGLResourceRepository:a.a,WebGLStrategyDataTexture:v,WebGLStrategyTransformFeedback:U,WebGLStrategyUBO:l,WebGLStrategyUniform:V});t.default=H}}]);
(0,eval)('this').Rn.WEBGL_VERSION='version: 0.1.1-601-gc8dc-mod branch: master';
