(window.webpackJsonp=window.webpackJsonp||[]).push([["webgl"],{46:function(e,t,r){"use strict";r.r(t);var i=r(24),a=r(26),n=r(19),o=r(33),s=r(10),_=r(23),u=function(){function e(){this.__webglResourceRepository=a.a.getInstance(),this.vertexShaderBody="\n\nvoid main ()\n{\n  mat4 worldMatrix = getMatrix(a_instanceID);\n  mat4 viewMatrix = getViewMatrix(a_instanceID);\n  mat4 projectionMatrix = getProjectionMatrix(a_instanceID);\n  mat3 normalMatrix = getNormalMatrix(a_instanceID);\n\n  v_position_inWorld = worldMatrix * vec4(a_position, 1.0);\n\n  gl_Position = projectionMatrix * viewMatrix * v_position_inWorld;\n  v_color = a_color;\n  v_normal_inWorld = normalMatrix * a_normal;\n  v_texcoord = a_texcoord;\n\n  // Light\n  vec3 lightPosition = vec3(10000.0, 100000.0, 100000.0);\n  v_lightDirection = normalize(lightPosition - v_position_inWorld.xyz);\n\n  // Skeletal\n\n  if (length(a_weight.xyz) > 0.01) {\n    mat4 skinMat = a_weight.x * u_skinMatrices[int(a_joint.x)];\n    skinMat += a_weight.y * u_skinMatrices[int(a_joint.y)];\n    skinMat += a_weight.z * u_skinMatrices[int(a_joint.z)];\n    skinMat += a_weight.w * u_skinMatrices[int(a_joint.w)];\n    v_position_inWorld = skinMat * vec4(a_position, 1.0);\n    normalMatrix = toNormalMatrix(skinMat);\n    v_normal_inWorld = normalize(normalMatrix * a_normal);\n    gl_Position = projectionMatrix * viewMatrix * v_position_inWorld;\n  }\n\n//  v_color = vec3(u_skinMatrices[int(a_joint.x)][1].xyz);\n}\n  "}return e.getInstance=function(){return this.__instance||(this.__instance=new e),this.__instance},Object.defineProperty(e.prototype,"glsl_rt0",{get:function(){return this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2?"layout(location = 0) out vec4 rt0;\n":"vec4 rt0;\n"},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"glsl_fragColor",{get:function(){return this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2?"":"gl_FragColor = rt0;\n"},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"glsl_vertex_in",{get:function(){return this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2?"in":"attribute"},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"glsl_fragment_in",{get:function(){return this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2?"in":"varying"},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"glsl_vertex_out",{get:function(){return this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2?"out":"varying"},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"glsl_texture",{get:function(){return this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2?"texture":"texture2D"},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"glsl_versionText",{get:function(){return this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2?"#version 300 es\n":""},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"vertexShaderVariableDefinitions",{get:function(){var e=this.glsl_versionText,t=this.glsl_vertex_in,r=this.glsl_vertex_out;return e+"\nprecision highp float;\n"+t+" vec3 a_position;\n"+t+" vec3 a_color;\n"+t+" vec3 a_normal;\n"+t+" float a_instanceID;\n"+t+" vec2 a_texcoord;\n"+t+" vec4 a_joint;\n"+t+" vec4 a_weight;\n"+r+" vec3 v_color;\n"+r+" vec3 v_normal_inWorld;\n"+r+" vec4 v_position_inWorld;\n"+r+" vec3 v_lightDirection;\n"+r+" vec2 v_texcoord;\nuniform mat4 u_skinMatrices[100];\n\nmat3 toNormalMatrix(mat4 m) {\n  float a00 = m[0][0], a01 = m[0][1], a02 = m[0][2], a03 = m[0][3],\n  a10 = m[1][0], a11 = m[1][1], a12 = m[1][2], a13 = m[1][3],\n  a20 = m[2][0], a21 = m[2][1], a22 = m[2][2], a23 = m[2][3],\n  a30 = m[3][0], a31 = m[3][1], a32 = m[3][2], a33 = m[3][3];\n\n  float b00 = a00 * a11 - a01 * a10,\n  b01 = a00 * a12 - a02 * a10,\n  b02 = a00 * a13 - a03 * a10,\n  b03 = a01 * a12 - a02 * a11,\n  b04 = a01 * a13 - a03 * a11,\n  b05 = a02 * a13 - a03 * a12,\n  b06 = a20 * a31 - a21 * a30,\n  b07 = a20 * a32 - a22 * a30,\n  b08 = a20 * a33 - a23 * a30,\n  b09 = a21 * a32 - a22 * a31,\n  b10 = a21 * a33 - a23 * a31,\n  b11 = a22 * a33 - a23 * a32;\n\n  float determinantVal = b00 * b11 - b01 * b10 + b02 * b09 + b03 * b08 - b04 * b07 + b05 * b06;\n\n  return mat3(\n    a11 * b11 - a12 * b10 + a13 * b09, a12 * b08 - a10 * b11 - a13 * b07, a10 * b10 - a11 * b08 + a13 * b06,\n    a02 * b10 - a01 * b11 - a03 * b09, a00 * b11 - a02 * b08 + a03 * b07, a01 * b08 - a00 * b10 - a03 * b06,\n    a31 * b05 - a32 * b04 + a33 * b03, a32 * b02 - a30 * b05 - a33 * b01, a30 * b04 - a31 * b02 + a33 * b00) / determinantVal;\n}\n\n"},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fragmentShaderSimple",{get:function(){var e=this.glsl_versionText,t=this.glsl_fragment_in,r=this.glsl_rt0,i=this.glsl_fragColor;return e+"\nprecision highp float;\n\nstruct Material {\n  vec4 baseColor;\n  sampler2D baseColorTexture;\n};\n\nuniform Material u_material;\n\n"+t+" vec3 v_color;\n"+t+" vec3 v_normal_inWorld;\n"+t+" vec4 v_position_inWorld;\n"+t+" vec3 v_lightDirection;\n"+t+" vec2 v_texcoord;\n"+r+"\nvoid main ()\n{\n  // Light\n  //vec3 lightPosition = vec3(0.0, 0.0, 50000.0);\n\n  // Normal\n  vec3 normal_inWorld = normalize(v_normal_inWorld);\n\n  // baseColor\n  vec3 color = vec3(0.0, 0.0, 0.0);\n  if (v_color != color && u_material.baseColor.rgb != color) {\n    color = v_color * u_material.baseColor.rgb;\n  } else if (v_color == color) {\n    color = u_material.baseColor.rgb;\n  } else if (u_material.baseColor.rgb == color) {\n    color = v_color;\n  } else {\n    color = vec3(1.0, 1.0, 1.0);\n  }\n  //color = v_color;\n\n  // baseColorTexture\n  vec4 textureColor = "+this.glsl_texture+"(u_material.baseColorTexture, v_texcoord);\n  if (textureColor.r > 0.05) {\n    color *= textureColor.rgb;\n  }\n\n  // Lighting\n  if (length(v_normal_inWorld) > 0.02) {\n    vec3 lightDirection = normalize(v_lightDirection);\n    float diffuse = 1.0 * max(0.0, dot(normal_inWorld, lightDirection));\n    color *= diffuse;\n  }\n\n  rt0 = vec4(color, 1.0);\n\n\n  "+i+"\n}\n"},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fragmentShader",{get:function(){return this.fragmentShaderSimple},enumerable:!0,configurable:!0}),e.attributeNames=["a_position","a_color","a_normal","a_texcoord","a_joint","a_weight","a_instanceID"],e.attributeSemantics=[_.a.Position,_.a.Color0,_.a.Normal,_.a.Texcoord0,_.a.Joints0,_.a.Weights0,_.a.Instance],e}(),c=r(6),l=r(20),d=function(){function e(){this.__webglResourceRepository=a.a.getInstance(),this.__uboUid=l.a.InvalidCGAPIResourceUid,this.__shaderProgramUid=l.a.InvalidCGAPIResourceUid,this.__vertexHandles=[],this.__isVAOSet=!1,this.vertexShaderMethodDefinitions_UBO="layout (std140) uniform matrix {\n    mat4 world[1024];\n  } u_matrix;\n\n  uniform mat4 u_viewMatrix;\n  uniform mat4 u_projectionMatrix;\n  uniform mat3 u_normalMatrix;\n\n  mat4 getMatrix(float instanceId) {\n    float index = instanceId;\n    return transpose(u_matrix.world[int(index)]);\n  }\n\n  mat4 getViewMatrix(float instanceId) {\n    return u_viewMatrix;\n  }\n\n  mat4 getProjectionMatrix(float instanceId) {\n    return u_projectionMatrix;\n  }\n\n  mat3 getNormalMatrix(float instanceId) {\n    return u_normalMatrix;\n  }\n\n  "}return e.prototype.setupShaderProgram=function(){if(this.__shaderProgramUid===l.a.InvalidCGAPIResourceUid){var e=u.getInstance(),t=e.vertexShaderVariableDefinitions+this.vertexShaderMethodDefinitions_UBO+e.vertexShaderBody,r=e.fragmentShader;this.__shaderProgramUid=this.__webglResourceRepository.createShaderProgram({vertexShaderStr:t,fragmentShaderStr:r,attributeNames:u.attributeNames,attributeSemantics:u.attributeSemantics});var i=this.__webglResourceRepository.getWebGLResource(this.__shaderProgramUid),a=this.__webglResourceRepository.currentWebGLContextWrapper.getRawContext();this.__uniformLocation_viewMatrix=a.getUniformLocation(i,"u_viewMatrix"),this.__uniformLocation_projectionMatrix=a.getUniformLocation(i,"u_projectionMatrix")}},e.prototype.__isLoaded=function(e){return null!=this.__vertexHandles[e]},e.prototype.$load=function(t){if(!this.__isLoaded(0))for(var r=t.getPrimitiveNumber(),i=0;i<r;i++){var a=t.getPrimitiveAt(i),n=this.__webglResourceRepository.createVertexDataResources(a);this.__vertexHandles[i]=n,e.__vertexHandleOfPrimitiveObjectUids.set(a.objectUid,n)}},e.prototype.$prerender=function(t,r){if(!this.__isVAOSet){for(var i=t.getPrimitiveNumber(),a=0;a<i;a++){var n=t.getPrimitiveAt(a);this.__vertexHandles[a]=e.__vertexHandleOfPrimitiveObjectUids.get(n.objectUid),this.__webglResourceRepository.setVertexDataToPipeline(this.__vertexHandles[a],n,r)}this.__isVAOSet=!0}},e.prototype.common_$prerender=function(){var e=n.a.getInstance().getBuffer(c.a.GPUInstanceData);new Float32Array(e.getArrayBuffer());this.__uboUid===l.a.InvalidCGAPIResourceUid?(this.__uboUid=this.__webglResourceRepository.createUniformBuffer(s.a.getAccessor("worldMatrix",s.a).dataViewOfBufferView),this.__webglResourceRepository.bindUniformBufferBase(0,this.__uboUid)):this.__webglResourceRepository.updateUniformBuffer(this.__uboUid,s.a.getAccessor("worldMatrix",s.a).dataViewOfBufferView)},e.prototype.attachGPUData=function(){this.__webglResourceRepository.bindUniformBlock(this.__shaderProgramUid,"matrix",0)},e.prototype.attatchShaderProgram=function(){var e=this.__shaderProgramUid,t=this.__webglResourceRepository.currentWebGLContextWrapper.getRawContext(),r=this.__webglResourceRepository.getWebGLResource(e);t.useProgram(r)},e.prototype.attachVertexData=function(e,t,r,i){var a=this.__vertexHandles[e],n=this.__webglResourceRepository.getWebGLResource(a.vaoHandle),o=r.getRawContext();if(null!=n)r.bindVertexArray(n);else{this.__webglResourceRepository.setVertexDataToPipeline(a,t,i);var s=this.__webglResourceRepository.getWebGLResource(a.iboHandle);o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,s)}},e.getInstance=function(){return this.__instance||(this.__instance=new e),this.__instance},e.prototype.common_$render=function(e,t){var r=this.__webglResourceRepository.currentWebGLContextWrapper;this.attatchShaderProgram();var i=r.getRawContext();return i.uniformMatrix4fv(this.__uniformLocation_viewMatrix,!1,e.v),i.uniformMatrix4fv(this.__uniformLocation_projectionMatrix,!1,t.v),!0},e.__vertexHandleOfPrimitiveObjectUids=new Map,e}(),h=r(21),p=r(30),g=r(1),f=r(22),m=r(25),b=r(18),x=r(34),v=r(4),R=r(29),y=function(){function e(){this.__webglResourceRepository=a.a.getInstance(),this.__instanceDataTextureUid=l.a.InvalidCGAPIResourceUid,this.__vertexDataTextureUid=l.a.InvalidCGAPIResourceUid,this.__shaderProgramUid=l.a.InvalidCGAPIResourceUid,this.__primitiveHeaderUboUid=l.a.InvalidCGAPIResourceUid,this.__indexCountToSubtractUboUid=l.a.InvalidCGAPIResourceUid,this.__entitiesUidUboUid=l.a.InvalidCGAPIResourceUid,this.__primitiveUidUboUid=l.a.InvalidCGAPIResourceUid,this.__isVertexReady=!1}return Object.defineProperty(e.prototype,"__transformFeedbackShaderText",{get:function(){u.getInstance().glsl_vertex_in,u.getInstance().glsl_texture;return"#version 300 es\n\n    layout (std140) uniform indexCountsToSubtract {\n      ivec4 counts[256];\n    } u_indexCountsToSubtract;\n    layout (std140) uniform entityUids {\n      ivec4 ids[256];\n    } u_entityData;\n    layout (std140) uniform primitiveUids {\n      ivec4 ids[256];\n    } u_primitiveData;\n    layout (std140) uniform primitiveHeader {\n      ivec4 data[256];\n    } u_primitiveHeader;\n\n    out vec4 position;\n    //out vec3 colors;\n\n    uniform sampler2D u_instanceDataTexture;\n    uniform sampler2D u_vertexDataTexture;\n\n    void main(){\n      int indexOfVertices = gl_VertexID + 3*gl_InstanceID;\n\n      int entityUidMinusOne = 0;\n      int primitiveUid = 0;\n      for (int i=0; i<=indexOfVertices; i++) {\n        for (int j=0; j<1024; j++) {\n          int value = u_indexCountsToSubtract.counts[j/4][j%4];\n          int result = int(step(float(value), float(i)));\n          if (result > 0) {\n            entityUidMinusOne = result * int(u_entityData.ids[j/4][j%4]) - 1;\n            primitiveUid = result * u_primitiveData.ids[j/4][j%4];\n          } else {\n            break;\n          }\n        }\n      }\n\n      ivec4 indicesMeta = u_primitiveHeader.data[9*primitiveUid + 0];\n      int primIndicesByteOffset = indicesMeta.x;\n      int primIndicesComponentSizeInByte = indicesMeta.y;\n      int primIndicesLength = indicesMeta.z;\n\n      int idx = gl_VertexID - primIndicesByteOffset / 4 /*byte*/;\n\n      // get Indices\n      int texelLength = "+n.a.bufferWidthLength+";\n      vec4 indexVec4 = texelFetch(u_vertexDataTexture, ivec2(idx%texelLength, idx/texelLength), 0);\n      int index = int(indexVec4[idx%4]);\n\n      // get Positions\n      ivec4 indicesData = u_primitiveHeader.data[9*primitiveUid + 1];\n      int primPositionsByteOffset = indicesData.x;\n      idx = primPositionsByteOffset/4 + index;\n      vec4 posVec4 = texelFetch(u_vertexDataTexture, ivec2(idx%texelLength, idx/texelLength), 0);\n\n      position = posVec4;\n    }\n"},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"__transformFeedbackFragmentShaderText",{get:function(){return"#version 300 es\nprecision highp float;\n\nout vec4 outColor;\n\nvoid main(){\n    outColor = vec4(1.0);\n}\n    "},enumerable:!0,configurable:!0}),e.prototype.setupShaderProgram=function(){if(this.__shaderProgramUid===l.a.InvalidCGAPIResourceUid){var e=this.__transformFeedbackShaderText,t=this.__transformFeedbackFragmentShaderText;this.__shaderProgramUid=this.__webglResourceRepository.createShaderProgram({vertexShaderStr:e,fragmentShaderStr:t,attributeNames:u.attributeNames,attributeSemantics:u.attributeSemantics});var r=this.__webglResourceRepository.getWebGLResource(this.__shaderProgramUid),i=this.__webglResourceRepository.currentWebGLContextWrapper.getRawContext();this.__uniformLocation_viewMatrix=i.getUniformLocation(r,"u_viewMatrix"),this.__uniformLocation_projectionMatrix=i.getUniformLocation(r,"u_projectionMatrix")}},e.prototype.$load=function(e){if(!this.__isVertexReady){var t=n.a.getInstance().getBuffer(c.a.CPUGeneric),r=t.takeBufferView({byteLengthToNeed:12,byteStride:4,isAoS:!1}).takeAccessor({compositionType:v.a.Scalar,componentType:g.a.UnsingedInt,count:3}),i=t.takeBufferView({byteLengthToNeed:48,byteStride:16,isAoS:!1}).takeAccessor({compositionType:v.a.Vec4,componentType:g.a.Float,count:3}),a=r.getTypedArray();a[0]=0,a[1]=1,a[2]=2;var o=x.a.createPrimitive({indices:a,attributeCompositionTypes:[i.compositionType],attributeSemantics:[_.a.Position],attributes:[i.getTypedArray()],primitiveMode:R.a.Triangles,material:void 0});this.__vertexHandle=this.__webglResourceRepository.createVertexDataResources(o),this.__isVertexReady=!0}},e.prototype.$prerender=function(e,t){},e.prototype.__setupUBOPrimitiveHeaderData=function(){var e=n.a.getInstance().getBuffer(c.a.UBOGeneric),t=new Int32Array(e.getArrayBuffer());this.__primitiveHeaderUboUid===l.a.InvalidCGAPIResourceUid&&(this.__primitiveHeaderUboUid=this.__webglResourceRepository.createUniformBuffer(t),this.__webglResourceRepository.bindUniformBufferBase(3,this.__primitiveHeaderUboUid))},e.prototype.__setupGPUInstanceMetaData=function(){if(this.__primitiveUidUboUid===l.a.InvalidCGAPIResourceUid){var e=m.a.getInstance()._getEntities(),t=new Int32Array(e.length),r=new Int32Array(e.length),i=new Int32Array(e.length),a=0;e.forEach(function(e,n){var o=e.getComponent(b.a);if(o){r[n]=o.getPrimitiveAt(0).primitiveUid,t[n]=e.entityUID;var s=o.getPrimitiveAt(0).indicesAccessor.elementCount;i[n]=a+s,a+=s}}),this.__indexCountToSubtractUboUid=this.__webglResourceRepository.createUniformBuffer(i),this.__webglResourceRepository.bindUniformBufferBase(0,this.__indexCountToSubtractUboUid),this.__entitiesUidUboUid=this.__webglResourceRepository.createUniformBuffer(t),this.__webglResourceRepository.bindUniformBufferBase(1,this.__entitiesUidUboUid),this.__primitiveUidUboUid=this.__webglResourceRepository.createUniformBuffer(r),this.__webglResourceRepository.bindUniformBufferBase(2,this.__primitiveUidUboUid)}},e.prototype.__setupGPUInstanceData=function(){var e=!1;(this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2||this.__webglResourceRepository.currentWebGLContextWrapper.isSupportWebGL1Extension(h.a.TextureHalfFloat))&&(e=!0);var t,r=n.a.getInstance().getBuffer(c.a.GPUInstanceData),i=new Float32Array(r.getArrayBuffer());if(e){t=new Uint16Array(i.length);var a=r.byteSizeInUse/4;a/=2;for(var s=0;s<a;s++)t[s]=o.a.toHalfFloat(i[s])}this.__instanceDataTextureUid===l.a.InvalidCGAPIResourceUid?e?this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2?this.__instanceDataTextureUid=this.__webglResourceRepository.createTexture(i,{level:0,internalFormat:f.a.RGBA16F,width:n.a.bufferWidthLength,height:n.a.bufferHeightLength,border:0,format:p.a.RGBA,type:g.a.Float,magFilter:f.a.Nearest,minFilter:f.a.Nearest,wrapS:f.a.Repeat,wrapT:f.a.Repeat,generateMipmap:!1,anisotropy:!1}):this.__instanceDataTextureUid=this.__webglResourceRepository.createTexture(t,{level:0,internalFormat:p.a.RGBA,width:n.a.bufferWidthLength,height:n.a.bufferHeightLength,border:0,format:p.a.RGBA,type:g.a.HalfFloat,magFilter:f.a.Nearest,minFilter:f.a.Nearest,wrapS:f.a.Repeat,wrapT:f.a.Repeat,generateMipmap:!1,anisotropy:!1}):this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2?this.__instanceDataTextureUid=this.__webglResourceRepository.createTexture(i,{level:0,internalFormat:f.a.RGBA32F,width:n.a.bufferWidthLength,height:n.a.bufferHeightLength,border:0,format:p.a.RGBA,type:g.a.Float,magFilter:f.a.Nearest,minFilter:f.a.Nearest,wrapS:f.a.Repeat,wrapT:f.a.Repeat,generateMipmap:!1,anisotropy:!1}):this.__instanceDataTextureUid=this.__webglResourceRepository.createTexture(i,{level:0,internalFormat:p.a.RGBA,width:n.a.bufferWidthLength,height:n.a.bufferHeightLength,border:0,format:p.a.RGBA,type:g.a.Float,magFilter:f.a.Nearest,minFilter:f.a.Nearest,wrapS:f.a.Repeat,wrapT:f.a.Repeat,generateMipmap:!1,anisotropy:!1}):e?this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2?this.__webglResourceRepository.updateTexture(this.__instanceDataTextureUid,i,{level:0,width:n.a.bufferWidthLength,height:n.a.bufferHeightLength,format:p.a.RGBA,type:g.a.Float}):this.__webglResourceRepository.updateTexture(this.__instanceDataTextureUid,t,{level:0,width:n.a.bufferWidthLength,height:n.a.bufferHeightLength,format:p.a.RGBA,type:g.a.HalfFloat}):(this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2,this.__webglResourceRepository.updateTexture(this.__instanceDataTextureUid,i,{level:0,width:n.a.bufferWidthLength,height:n.a.bufferHeightLength,format:p.a.RGBA,type:g.a.Float}))},e.prototype.__setupGPUVertexData=function(){if(this.__vertexDataTextureUid===l.a.InvalidCGAPIResourceUid){var e=n.a.getInstance().getBuffer(c.a.GPUVertexData),t=new Float32Array(e.getArrayBuffer());this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2?this.__vertexDataTextureUid=this.__webglResourceRepository.createTexture(t,{level:0,internalFormat:f.a.RGBA32F,width:n.a.bufferWidthLength,height:n.a.bufferHeightLength,border:0,format:p.a.RGBA,type:g.a.Float,magFilter:f.a.Nearest,minFilter:f.a.Nearest,wrapS:f.a.Repeat,wrapT:f.a.Repeat,generateMipmap:!1,anisotropy:!1}):this.__vertexDataTextureUid=this.__webglResourceRepository.createTexture(t,{level:0,internalFormat:p.a.RGBA,width:n.a.bufferWidthLength,height:n.a.bufferHeightLength,border:0,format:p.a.RGBA,type:g.a.Float,magFilter:f.a.Nearest,minFilter:f.a.Nearest,wrapS:f.a.Repeat,wrapT:f.a.Repeat,generateMipmap:!1,anisotropy:!1})}},e.prototype.common_$prerender=function(){this.__setupUBOPrimitiveHeaderData(),this.__setupGPUInstanceMetaData(),this.__setupGPUInstanceData(),this.__setupGPUVertexData()},e.prototype.attachGPUData=function(){var e=this.__webglResourceRepository.currentWebGLContextWrapper.getRawContext(),t=this.__webglResourceRepository.getWebGLResource(this.__instanceDataTextureUid);e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,t);var r=this.__webglResourceRepository.getWebGLResource(this.__shaderProgramUid),i=e.getUniformLocation(r,"u_instanceDataTexture");e.uniform1i(i,0);e=this.__webglResourceRepository.currentWebGLContextWrapper.getRawContext(),t=this.__webglResourceRepository.getWebGLResource(this.__vertexDataTextureUid);e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,t);r=this.__webglResourceRepository.getWebGLResource(this.__shaderProgramUid);var a=e.getUniformLocation(r,"u_vertexDataTexture");e.uniform1i(a,1),this.__webglResourceRepository.bindUniformBlock(this.__shaderProgramUid,"indexCountsToSubtract",0),this.__webglResourceRepository.bindUniformBlock(this.__shaderProgramUid,"entityUids",1),this.__webglResourceRepository.bindUniformBlock(this.__shaderProgramUid,"primitiveUids",2),this.__webglResourceRepository.bindUniformBlock(this.__shaderProgramUid,"primitiveHeader",3)},e.prototype.attatchShaderProgram=function(){var e=this.__shaderProgramUid,t=this.__webglResourceRepository.currentWebGLContextWrapper.getRawContext(),r=this.__webglResourceRepository.getWebGLResource(e);t.useProgram(r)},e.prototype.attachVertexData=function(e,t,r,i){},e.getInstance=function(){return this.__instance||(this.__instance=new e),this.__instance},e.prototype.common_$render=function(e,t){var r=this.__webglResourceRepository.currentWebGLContextWrapper;this.attatchShaderProgram();var i=r.getRawContext();return i.uniformMatrix4fv(this.__uniformLocation_viewMatrix,!1,e.v),i.uniformMatrix4fv(this.__uniformLocation_projectionMatrix,!1,t.v),!0},e}(),w=function(){function e(){this.__webglResourceRepository=a.a.getInstance(),this.__dataTextureUid=l.a.InvalidCGAPIResourceUid,this.__shaderProgramUid=l.a.InvalidCGAPIResourceUid,this.__vertexHandles=[],this.__isVAOSet=!1}return Object.defineProperty(e.prototype,"vertexShaderMethodDefinitions_dataTexture",{get:function(){var e=u.getInstance().glsl_texture;return"\n  uniform sampler2D u_dataTexture;\n  uniform mat4 u_viewMatrix;\n  uniform mat4 u_projectionMatrix;\n  uniform mat3 u_normalMatrix;\n\n  /*\n   * This idea from https://qiita.com/YVT/items/c695ab4b3cf7faa93885\n   * arg = vec2(1. / size.x, 1. / size.x / size.y);\n   */\n  // vec4 fetchElement(sampler2D tex, float index, vec2 arg)\n  // {\n  //   return "+e+"( tex, arg * (index + 0.5) );\n  // }\n\n  vec4 fetchElement(sampler2D tex, float index, vec2 invSize)\n  {\n    float t = (index + 0.5) * invSize.x;\n    float x = fract(t);\n    float y = (floor(t) + 0.5) * invSize.y;\n    return "+e+"( tex, vec2(x, y) );\n  }\n\n  mat4 getMatrix(float instanceId)\n  {\n    float index = instanceId;\n    float powWidthVal = "+n.a.bufferWidthLength+".0;\n    float powHeightVal = "+n.a.bufferHeightLength+".0;\n    vec2 arg = vec2(1.0/powWidthVal, 1.0/powHeightVal);\n  //  vec2 arg = vec2(1.0/powWidthVal, 1.0/powWidthVal/powHeightVal);\n\n    vec4 col0 = fetchElement(u_dataTexture, index * 4.0 + 0.0, arg);\n   vec4 col1 = fetchElement(u_dataTexture, index * 4.0 + 1.0, arg);\n   vec4 col2 = fetchElement(u_dataTexture, index * 4.0 + 2.0, arg);\n\n    mat4 matrix = mat4(\n      col0.x, col1.x, col2.x, 0.0,\n      col0.y, col1.y, col2.y, 0.0,\n      col0.z, col1.z, col2.z, 0.0,\n      col0.w, col1.w, col2.w, 1.0\n      );\n\n    return matrix;\n  }\n\n  mat4 getViewMatrix(float instanceId) {\n    return u_viewMatrix;\n  }\n\n  mat4 getProjectionMatrix(float instanceId) {\n    return u_projectionMatrix;\n  }\n\n  mat3 getNormalMatrix(float instanceId) {\n    return u_normalMatrix;\n  }\n\n  "},enumerable:!0,configurable:!0}),e.prototype.setupShaderProgram=function(){if(this.__shaderProgramUid===l.a.InvalidCGAPIResourceUid){var e=u.getInstance(),t=e.vertexShaderVariableDefinitions+this.vertexShaderMethodDefinitions_dataTexture+e.vertexShaderBody,r=e.fragmentShader;this.__shaderProgramUid=this.__webglResourceRepository.createShaderProgram({vertexShaderStr:t,fragmentShaderStr:r,attributeNames:u.attributeNames,attributeSemantics:u.attributeSemantics});var i=this.__webglResourceRepository.getWebGLResource(this.__shaderProgramUid),a=this.__webglResourceRepository.currentWebGLContextWrapper.getRawContext();this.__uniformLocation_viewMatrix=a.getUniformLocation(i,"u_viewMatrix"),this.__uniformLocation_projectionMatrix=a.getUniformLocation(i,"u_projectionMatrix")}},e.prototype.__isLoaded=function(e){return null!=this.__vertexHandles[e]},e.prototype.$load=function(t){if(!this.__isLoaded(0))for(var r=t.getPrimitiveNumber(),i=0;i<r;i++){var a=t.getPrimitiveAt(i),n=this.__webglResourceRepository.createVertexDataResources(a);this.__vertexHandles[i]=n,e.__vertexHandleOfPrimitiveObjectUids.set(a.objectUid,n)}},e.prototype.$prerender=function(t,r){if(!this.__isVAOSet){for(var i=t.getPrimitiveNumber(),a=0;a<i;a++){var n=t.getPrimitiveAt(a);this.__vertexHandles[a]=e.__vertexHandleOfPrimitiveObjectUids.get(n.objectUid),this.__webglResourceRepository.setVertexDataToPipeline(this.__vertexHandles[a],n,r)}this.__isVAOSet=!0}},e.prototype.common_$prerender=function(){var e=!1;(this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2||this.__webglResourceRepository.currentWebGLContextWrapper.isSupportWebGL1Extension(h.a.TextureHalfFloat))&&(e=!0);var t,r=n.a.getInstance().getBuffer(c.a.GPUInstanceData),i=new Float32Array(r.getArrayBuffer());if(e){t=new Uint16Array(i.length);var a=r.byteSizeInUse/4;a/=2;for(var s=0;s<a;s++)t[s]=o.a.toHalfFloat(i[s])}this.__dataTextureUid===l.a.InvalidCGAPIResourceUid?e?this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2?this.__dataTextureUid=this.__webglResourceRepository.createTexture(i,{level:0,internalFormat:f.a.RGBA16F,width:n.a.bufferWidthLength,height:n.a.bufferHeightLength,border:0,format:p.a.RGBA,type:g.a.Float,magFilter:f.a.Nearest,minFilter:f.a.Nearest,wrapS:f.a.Repeat,wrapT:f.a.Repeat,generateMipmap:!1,anisotropy:!1}):this.__dataTextureUid=this.__webglResourceRepository.createTexture(t,{level:0,internalFormat:p.a.RGBA,width:n.a.bufferWidthLength,height:n.a.bufferHeightLength,border:0,format:p.a.RGBA,type:g.a.HalfFloat,magFilter:f.a.Nearest,minFilter:f.a.Nearest,wrapS:f.a.Repeat,wrapT:f.a.Repeat,generateMipmap:!1,anisotropy:!1}):this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2?this.__dataTextureUid=this.__webglResourceRepository.createTexture(i,{level:0,internalFormat:f.a.RGBA32F,width:n.a.bufferWidthLength,height:n.a.bufferHeightLength,border:0,format:p.a.RGBA,type:g.a.Float,magFilter:f.a.Nearest,minFilter:f.a.Nearest,wrapS:f.a.Repeat,wrapT:f.a.Repeat,generateMipmap:!1,anisotropy:!1}):this.__dataTextureUid=this.__webglResourceRepository.createTexture(i,{level:0,internalFormat:p.a.RGBA,width:n.a.bufferWidthLength,height:n.a.bufferHeightLength,border:0,format:p.a.RGBA,type:g.a.Float,magFilter:f.a.Nearest,minFilter:f.a.Nearest,wrapS:f.a.Repeat,wrapT:f.a.Repeat,generateMipmap:!1,anisotropy:!1}):e?this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2?this.__webglResourceRepository.updateTexture(this.__dataTextureUid,i,{level:0,width:n.a.bufferWidthLength,height:n.a.bufferHeightLength,format:p.a.RGBA,type:g.a.Float}):this.__webglResourceRepository.updateTexture(this.__dataTextureUid,t,{level:0,width:n.a.bufferWidthLength,height:n.a.bufferHeightLength,format:p.a.RGBA,type:g.a.HalfFloat}):(this.__webglResourceRepository.currentWebGLContextWrapper.isWebGL2,this.__webglResourceRepository.updateTexture(this.__dataTextureUid,i,{level:0,width:n.a.bufferWidthLength,height:n.a.bufferHeightLength,format:p.a.RGBA,type:g.a.Float}))},e.prototype.attachGPUData=function(){var e=this.__webglResourceRepository.currentWebGLContextWrapper.getRawContext(),t=this.__webglResourceRepository.getWebGLResource(this.__dataTextureUid);e.bindTexture(e.TEXTURE_2D,t);var r=this.__webglResourceRepository.getWebGLResource(this.__shaderProgramUid),i=e.getUniformLocation(r,"u_dataTexture");e.uniform1i(i,0)},e.prototype.attatchShaderProgram=function(){var e=this.__shaderProgramUid,t=this.__webglResourceRepository.currentWebGLContextWrapper.getRawContext(),r=this.__webglResourceRepository.getWebGLResource(e);t.useProgram(r)},e.prototype.attachVertexData=function(e,t,r,i){var a=this.__vertexHandles[e],n=this.__webglResourceRepository.getWebGLResource(a.vaoHandle),o=r.getRawContext();if(null!=n)r.bindVertexArray(n);else{this.__webglResourceRepository.setVertexDataToPipeline(a,t,i);var s=this.__webglResourceRepository.getWebGLResource(a.iboHandle);o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,s)}},e.getInstance=function(){return this.__instance||(this.__instance=new e),this.__instance},e.prototype.common_$render=function(e,t){var r=this.__webglResourceRepository.currentWebGLContextWrapper;this.attatchShaderProgram();var i=r.getRawContext();return i.uniformMatrix4fv(this.__uniformLocation_viewMatrix,!1,e.v),i.uniformMatrix4fv(this.__uniformLocation_projectionMatrix,!1,t.v),!0},e.__vertexHandleOfPrimitiveObjectUids=new Map,e}(),U=r(16),L=r(37),W=function(){function e(){this.__webglResourceRepository=a.a.getInstance(),this.__uboUid=l.a.InvalidCGAPIResourceUid,this.__shaderProgramUid=l.a.InvalidCGAPIResourceUid,this.__isVAOSet=!1,this.vertexShaderMethodDefinitions_uniform="\n  uniform mat4 u_worldMatrix;\n  uniform mat4 u_viewMatrix;\n  uniform mat4 u_projectionMatrix;\n  uniform mat3 u_normalMatrix;\n\n  mat4 getMatrix(float instanceId) {\n    return u_worldMatrix;\n  }\n\n  mat4 getViewMatrix(float instanceId) {\n    return u_viewMatrix;\n  }\n\n  mat4 getProjectionMatrix(float instanceId) {\n    return u_projectionMatrix;\n  }\n\n  mat3 getNormalMatrix(float instanceId) {\n    return u_normalMatrix;\n  }\n\n  "}return e.prototype.setupShaderProgram=function(){if(this.__shaderProgramUid===l.a.InvalidCGAPIResourceUid){var e=u.getInstance(),t=e.vertexShaderVariableDefinitions+this.vertexShaderMethodDefinitions_uniform+e.vertexShaderBody,r=e.fragmentShader;this.__shaderProgramUid=this.__webglResourceRepository.createShaderProgram({vertexShaderStr:t,fragmentShaderStr:r,attributeNames:u.attributeNames,attributeSemantics:u.attributeSemantics}),this.__shaderProgram=this.__webglResourceRepository.getWebGLResource(this.__shaderProgramUid);var i=this.__webglResourceRepository.currentWebGLContextWrapper.getRawContext();this.__uniformLocation_worldMatrix=i.getUniformLocation(this.__shaderProgram,"u_worldMatrix"),this.__uniformLocation_material=i.getUniformLocation(this.__shaderProgram,"u_material.baseColor"),this.__uniformLocation_viewMatrix=i.getUniformLocation(this.__shaderProgram,"u_viewMatrix"),this.__uniformLocation_projectionMatrix=i.getUniformLocation(this.__shaderProgram,"u_projectionMatrix"),this.__uniformLocation_normalMatrix=i.getUniformLocation(this.__shaderProgram,"u_normalMatrix"),this.__uniformLocation_baseColorTexture=i.getUniformLocation(this.__shaderProgram,"u_material.baseColorTexture"),this.__uniformLocation_skinMatrices=i.getUniformLocation(this.__shaderProgram,"u_skinMatrices")}},e.prototype.$load=function(t){for(var r=t.getPrimitiveNumber(),i=0;i<r;i++){var a=t.getPrimitiveAt(i),n=this.__webglResourceRepository.createVertexDataResources(a);e.__vertexHandleOfPrimitiveObjectUids.set(a.primitiveUid,n)}},e.prototype.$prerender=function(t,r){for(var i=[],a=t.getPrimitiveNumber(),n=0;n<a;n++){var o=t.getPrimitiveAt(n);i[n]=e.__vertexHandleOfPrimitiveObjectUids.get(o.primitiveUid),i[n].setComplete,this.__webglResourceRepository.setVertexDataToPipeline(i[n],o,r),i[n].setComplete=!0}},e.prototype.common_$prerender=function(){},e.prototype.attachGPUData=function(){},e.prototype.attatchShaderProgram=function(){this.__shaderProgramUid;this.__webglResourceRepository.currentWebGLContextWrapper.getRawContext().useProgram(this.__shaderProgram)},e.prototype.attachVertexData=function(t,r,i,a){var n=e.__vertexHandleOfPrimitiveObjectUids.get(r.primitiveUid),o=this.__webglResourceRepository.getWebGLResource(n.vaoHandle),s=i.getRawContext();if(null!=o)i.bindVertexArray(o);else{this.__webglResourceRepository.setVertexDataToPipeline(n,r,a);var _=this.__webglResourceRepository.getWebGLResource(n.iboHandle);s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,_)}},e.prototype.dettachVertexData=function(e){var t=e.getRawContext();e.bindVertexArray&&e.bindVertexArray(null),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),t.bindBuffer(t.ARRAY_BUFFER,null)},e.getInstance=function(){return this.__instance||(this.__instance=new e),this.__instance},e.prototype.common_$render=function(e,t){var r=this.__webglResourceRepository.currentWebGLContextWrapper;this.attatchShaderProgram();var i=r.getRawContext();return i.uniformMatrix4fv(this.__uniformLocation_viewMatrix,!1,e.v),i.uniformMatrix4fv(this.__uniformLocation_projectionMatrix,!1,t.v),!1},e.prototype.$render=function(e,t,r,i,a){var n=this.__webglResourceRepository.currentWebGLContextWrapper;this.attatchShaderProgram();var o=n.getRawContext();this.attachVertexData(e,t,n,l.a.InvalidCGAPIResourceUid),o.uniformMatrix4fv(this.__uniformLocation_worldMatrix,!1,U.a.transpose(r).v),o.uniformMatrix3fv(this.__uniformLocation_normalMatrix,!1,i.v);var s=t.material,_=[];s?(_[0]=s.baseColor.r,_[1]=s.baseColor.g,_[2]=s.baseColor.b,_[3]=s.alpha):(_[0]=1,_[1]=1,_[2]=1,_[3]=1),o.uniform4fv(this.__uniformLocation_material,_),o.uniform1i(this.__uniformLocation_baseColorTexture,0);var u=a.getComponent(L.a);if(u){var c=u.jointMatrices;o.uniformMatrix4fv(this.__uniformLocation_skinMatrices,!1,c)}if(s&&s.baseColorTexture){var d=this.__webglResourceRepository.getWebGLResource(s.baseColorTexture.texture3DAPIResourseUid);o.bindTexture(o.TEXTURE_2D,d)}o.drawElements(t.primitiveMode.index,t.indicesAccessor.elementCount,t.indicesAccessor.componentType.index,0),o.bindTexture(o.TEXTURE_2D,null),o.useProgram(null),this.dettachVertexData(n)},e.__vertexHandleOfPrimitiveObjectUids=new Map,e}(),P=function(e){return e.index===i.a.UBOWebGL2.index?d.getInstance():e.index===i.a.TransformFeedbackWebGL2.index?y.getInstance():e.index===i.a.UniformWebGL1.index?W.getInstance():w.getInstance()},G=r(38),M=Object.freeze({getRenderingStrategy:P,GLSLShader:u,WebGLContextWrapper:G.a,WebGLResourceRepository:a.a,WebGLStrategyDataTexture:w,WebGLStrategyTransformFeedback:y,WebGLStrategyUBO:d,WebGLStrategyUniform:W});t.default=M}}]);
(0,eval)('this').Rn.WEBGL_VERSION='version: 0.1.1-73-g17c2-mod branch: feature/refactor';
